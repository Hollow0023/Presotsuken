# アクセス制限フローチャート

## 1. レジ端末（管理者端末）のログインフロー

```
┌──────────────────────────────────────────┐
│         ユーザーがアクセス                │
│         http://server/login              │
└────────────────┬─────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────┐
│      LoginCheckInterceptor               │
│  Cookie に storeId が存在するか？         │
└─────────┬────────────────────────────────┘
          │
    ┌─────┴─────┐
    │ あり      │ なし → /login にリダイレクト
    ▼           │
┌──────────────────────────────────────────┐
│       自動ログイン試行                    │
│  storeId + storeName で店舗検証           │
└─────────┬────────────────────────────────┘
          │
    ┌─────┴─────┐
    │ 成功      │ 失敗
    ▼           ▼
   /seats   ログイン画面表示
              │
              ▼
┌──────────────────────────────────────────┐
│    ユーザーが店舗ID・店舗名を入力         │
│         POST /login                      │
└────────────────┬─────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────┐
│  1. 店舗ID + 店舗名で認証                 │
│     StoreRepository.                     │
│     existsByStoreIdAndStoreName()        │
└─────────┬────────────────────────────────┘
          │
    ┌─────┴─────┐
    │ 失敗      │ 成功
    ▼           ▼
/login?     ┌──────────────────────────────┐
error=true  │  2. クライアントIPアドレス取得  │
            │     getClientIp(request)      │
            │  ・X-Forwarded-For対応        │
            │  ・IPv6 → IPv4 変換           │
            └────────────┬─────────────────┘
                         │
                         ▼
            ┌──────────────────────────────┐
            │  3. Terminal検索              │
            │     findByIpAddressAndStore   │
            │     _StoreId(ip, storeId)     │
            └─────────┬────────────────────┘
                      │
                ┌─────┴─────┐
                │ 見つかった │ 見つからない
                ▼           ▼
    ┌────────────────┐   /login?error=
    │ Cookie保存     │   terminalNotFound
    │ ・storeId      │
    │ ・terminalId   │
    │ ・adminFlag    │
    │ ・storeName    │
    │ ・seatId (※)  │
    └───────┬────────┘
            │
            ▼
    ┌────────────────┐
    │  遷移先決定     │
    └───────┬────────┘
            │
      ┌─────┴─────┐
      │ 管理者    │ 一般
      ▼           ▼
   /seats   /visits/orderwait

※ 一般端末の場合のみ保存
```

## 2. テーブル端末のログインフロー

```
┌──────────────────────────────────────────┐
│         ユーザーがアクセス                │
│       http://server/tableLogin           │
└────────────────┬─────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────┐
│      LoginCheckInterceptor               │
│  Cookie に storeId が存在するか？         │
└─────────┬────────────────────────────────┘
          │
    ┌─────┴─────┐
    │ あり      │ なし → /tableLogin 
    ▼           │
┌──────────────────────────────────────────┐
│       自動ログイン試行                    │
│  storeId + storeName で店舗検証           │
└─────────┬────────────────────────────────┘
          │
    ┌─────┴─────┐
    │ 成功      │ 失敗
    ▼           ▼
/visits/     ログイン画面表示
orderwait        │
                 ▼
┌──────────────────────────────────────────┐
│    ユーザーが店舗ID・店舗名を入力         │
│       POST /tableLogin                   │
└────────────────┬─────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────┐
│  店舗ID + 店舗名で認証                    │
│  StoreRepository.findById()              │
│  + 店舗名の照合                           │
└─────────┬────────────────────────────────┘
          │
    ┌─────┴─────┐
    │ 失敗      │ 成功
    ▼           ▼
  エラー    ┌──────────────────────────────┐
  メッセージ │  Cookie保存                  │
            │  ・storeId                   │
            │  ・storeName                 │
            └────────────┬─────────────────┘
                         │
                         ▼
            ┌──────────────────────────────┐
            │  /visits/orderwait へ遷移     │
            └────────────┬─────────────────┘
                         │
                         ▼
            ┌──────────────────────────────┐
            │  VisitController.            │
            │  orderWaitPage()             │
            └────────────┬─────────────────┘
                         │
                         ▼
            ┌──────────────────────────────┐
            │  1. Cookie から storeId 取得  │
            └────────────┬─────────────────┘
                         │
                   ┌─────┴─────┐
                   │ なし      │ あり
                   ▼           ▼
            /tableLogin  ┌──────────────────┐
                         │  2. IPアドレス取得│
                         │  request.         │
                         │  getRemoteAddr()  │
                         └────────┬──────────┘
                                  │
                                  ▼
                         ┌──────────────────┐
                         │  3. Terminal検索  │
                         │  findByIpAddress  │
                         │  AndStore_StoreId │
                         └────────┬──────────┘
                                  │
                            ┌─────┴─────┐
                            │ 見つかった │ 見つからない
                            ▼           ▼
                    ┌───────────┐  RuntimeException
                    │ 座席特定   │  「端末が見つか
                    │ Cookie保存 │   りません」
                    │ ・seatId   │
                    │ ・visitId  │
                    └─────┬─────┘
                          │
                          ▼
                    ┌───────────┐
                    │  注文画面  │
                    │  /order    │
                    └───────────┘
```

## 3. 管理者ページへのアクセス

```
┌──────────────────────────────────────────┐
│    ユーザーが管理者ページにアクセス        │
│      http://server/admin/****            │
└────────────────┬─────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────┐
│      LoginCheckInterceptor               │
│  Cookie に storeId が存在するか？         │
└─────────┬────────────────────────────────┘
          │
    ┌─────┴─────┐
    │ なし      │ あり
    ▼           ▼
 /login   ┌──────────────────────────────┐
          │  AdminPageInterceptor         │
          │  Cookie の adminFlag をチェック│
          └─────────┬────────────────────┘
                    │
              ┌─────┴─────┐
              │ "true"   │ その他
              ▼          ▼
        管理者ページ   /login?admin=denied
        アクセス許可
```

## 4. 端末登録の流れ

```
┌──────────────────────────────────────────┐
│    管理者が管理画面にアクセス              │
│     http://server/admin/terminals        │
└────────────────┬─────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────┐
│      端末情報を入力                       │
│  ・座席ID（管理者端末は不要）              │
│  ・IPアドレス                             │
│  ・管理者フラグ                           │
└────────────────┬─────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────┐
│  TerminalService.createTerminal()        │
│                                          │
│  1. 入力バリデーション                    │
│     ・IPアドレスが空でないこと             │
│     ・座席が存在すること（非管理者の場合）  │
│     ・店舗が存在すること                  │
│                                          │
│  2. Terminal エンティティ作成             │
│     ・seat（座席）                        │
│     ・store（店舗）                       │
│     ・ipAddress（IPアドレス）             │
│     ・isAdmin（管理者フラグ）             │
│                                          │
│  3. データベースに保存                    │
│     terminalRepository.save()            │
└────────────────┬─────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────┐
│         端末登録完了                      │
│  この端末からログイン可能になる            │
└──────────────────────────────────────────┘
```

## 5. Terminal エンティティの構造

```
┌─────────────────────────────────────────┐
│             Terminal                    │
├─────────────────────────────────────────┤
│  terminalId: Integer (PK)               │
│    自動採番の端末ID                      │
│                                         │
│  seat: Seat (OneToOne)                  │
│    関連する座席（管理者端末は null）      │
│                                         │
│  store: Store (ManyToOne)               │
│    所属する店舗                          │
│                                         │
│  ipAddress: String                      │
│    端末のIPアドレス                      │
│    例: "192.168.1.100"                  │
│                                         │
│  isAdmin: boolean                       │
│    管理者端末フラグ                      │
│    true = レジ端末（管理者）             │
│    false = テーブル端末                  │
└─────────────────────────────────────────┘
```

## 重要なポイント

### レジ端末の特徴
- ✅ ログイン時にIPアドレスをチェック（事前検証）
- ✅ 未登録IPからはログイン不可
- ✅ 管理者権限が必要な機能にアクセス可能

### テーブル端末の特徴  
- ✅ ログインは店舗情報のみで可能（IPチェックなし）
- ✅ `/visits/orderwait` アクセス時にIPチェック（後付け検証）
- ⚠️ 未登録IPの場合は例外が発生し、エラーページに遷移

### セキュリティポイント
- 🔒 店舗名が事実上のパスワード
- 🔒 IPアドレスによる端末認証
- 🔒 Cookie で認証状態を管理（最大180日）
- 🔒 インターセプターで全ページの認証チェック
- 🔒 管理者ページは adminFlag で制御
