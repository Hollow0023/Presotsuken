# PreSotuken (プレソツケン) - 注文管理システム カスタム指示

## プロジェクト概要
PreSotukenは日本の飲食店向けの包括的な注文管理システムです。座席管理、注文処理、会計、印刷機能を統合したSpring Bootアプリケーションです。

## 技術スタック
- **Java 21** - 最新のJava機能を活用
- **Spring Boot 3.2.5** - メインフレームワーク
- **Spring Data JPA** - データベースアクセス
- **Thymeleaf** - テンプレートエンジン
- **WebSocket** - リアルタイム通信（座席状態更新等）
- **MySQL** - 本番データベース
- **H2** - テスト用インメモリDB
- **Gradle** - ビルドツール
- **Lombok** - ボイラープレートコード削減

## コーディング規約・パターン

### 1. 言語・コメント
- **日本語コメント推奨**: ビジネスロジックや複雑な処理には日本語でコメントを記述
- **英語変数名**: 変数名、メソッド名、クラス名は英語を使用
- **Javadoc**: パブリックメソッドには日本語でJavadocを記述

```java
/**
 * 座席の状態を更新し、WebSocketで通知します
 * 
 * @param seatId 座席ID
 * @param status 新しい状態
 */
public void updateSeatStatus(Integer seatId, SeatStatus status) {
    // 座席状態の更新処理
}
```

### 2. アーキテクチャパターン
- **Controller-Service-Repository** パターンを厳守
- **DTO** パターンでデータ転送オブジェクトを分離
- **Entity** はJPA仕様に従いデータベーステーブルと対応

### 3. パッケージ構造
```
com.order/
├── controller/     # REST API、画面コントローラー
├── service/        # ビジネスロジック
├── repository/     # データアクセス層
├── entity/         # JPA エンティティ
├── dto/           # データ転送オブジェクト
├── config/        # 設定クラス
├── interceptor/   # インターセプター（認証等）
├── exception/     # カスタム例外
└── util/          # ユーティリティクラス
```

### 4. Lombokアノテーション
- `@RequiredArgsConstructor` - final フィールドのコンストラクタ生成
- `@Getter`, `@Setter` - アクセサメソッド生成
- `@Entity`, `@Table` - JPA エンティティ定義

## 業務ドメイン知識

### 1. 座席管理システム
- **座席状態**: 空席(VACANT) → 使用中(OCCUPIED) → 会計待ち(PAYMENT_PENDING)
- **座席タイプ**: テーブル席、カウンター席、個室等
- **リアルタイム更新**: WebSocketで座席状態をリアルタイム同期

### 2. 注文管理
- **メニュー構造**: メニューグループ → メニューアイテム → オプション
- **注文フロー**: 注文 → 調理指示 → 提供 → 会計
- **印刷機能**: 注文票、レシート印刷（ESC/POS コマンド）

### 3. 会計システム
- **支払方法**: 現金、クレジットカード、電子マネー
- **税率計算**: 軽減税率対応（持ち帰り8%、店内10%）
- **割引機能**: 金額割引、理由付き割引

## データベース設計原則

### 1. エンティティ関係
```java
// 主要エンティティの関係例
Visit (来店) ←→ Seat (座席)
Visit ←→ Payment (会計)
Payment ←→ PaymentDetail (会計明細)
MenuGroup (メニューグループ) ←→ Menu (メニュー)
Menu ←→ OptionItem (オプション)
```

### 2. 命名規約
- テーブル名: 英語単数形（`user`, `seat`, `payment`）
- カラム名: キャメルケース（`userId`, `menuName`）
- 外部キー: `参照先テーブル名 + Id`（`userId`, `seatId`）

## フロントエンド開発

### 1. Thymeleafテンプレート
- **レイアウト**: `templates/` ディレクトリに配置
- **CSS/JS**: `static/css/`, `static/js/` に配置
- **画像**: `static/images/` に配置

### 2. JavaScript パターン
- **jQuery使用**: 既存コードとの整合性のため
- **WebSocket通信**: 座席状態、注文状態の即座更新
- **モーダルダイアログ**: 入力フォーム、確認ダイアログ

### 3. CSS設計
- **レスポンシブデザイン**: タブレット端末での利用を想定
- **色彩**: 直感的な状態表示（緑=空席、青=使用中、赤=異常）
- **タッチフレンドリー**: ボタンサイズ、間隔に配慮

## 印刷システム

### 1. ESC/POS コマンド
- **JSONコマンド形式**: フロントエンドでESC/POSコマンドをJSON化
- **印刷タイプ**: レシート印刷、注文票印刷、ラベル印刷
- **エラーハンドリング**: プリンター接続エラー、用紙切れ対応

## テスト戦略

### 1. 単体テスト
- **Service層**: ビジネスロジックの検証
- **Repository層**: データアクセス層の検証
- **MockMvc**: Controller層のHTTPレスポンス検証

### 2. 統合テスト
- **@SpringBootTest**: アプリケーション全体のテスト
- **H2データベース**: テスト用インメモリDB使用
- **WebSocket**: リアルタイム通信のテスト

## セキュリティ要件

### 1. 認証・認可
- **セッション管理**: スタッフログイン機能
- **権限制御**: 管理者機能、一般スタッフ機能の分離
- **CSRF対策**: Spring Securityによる保護

### 2. データ保護
- **SQL インジェクション対策**: JPA PreparedStatement使用
- **XSS対策**: Thymeleafのエスケープ機能活用

## パフォーマンス要件

### 1. データベース最適化
- **インデックス**: 頻繁な検索カラムにインデックス設定
- **N+1問題回避**: @EntityGraphやJOIN FETCHの適切な使用
- **ページネーション**: 大量データの表示制御

### 2. キャッシュ戦略
- **Spring Cache**: メニューデータ等の静的データキャッシュ
- **セッション最適化**: 不要なセッションデータの削除

## デプロイメント・運用

### 1. 設定管理
- **application.properties**: 環境別設定（dev, staging, prod）
- **外部設定**: データベース接続情報、印刷設定等

### 2. ログ設定
- **業務ログ**: 注文、会計、座席操作の記録
- **エラーログ**: 例外、システムエラーの詳細記録
- **アクセスログ**: API呼び出し、画面遷移の記録

## 開発ワークフロー

### 1. 機能開発手順
1. **要件理解**: 業務フローと技術要件の確認
2. **データ設計**: エンティティ、DTO設計
3. **API設計**: RESTエンドポイント設計
4. **実装**: Repository → Service → Controller の順
5. **テスト**: 単体テスト → 統合テスト
6. **フロントエンド**: HTML/CSS/JavaScript実装

### 2. Git ワークフロー
- **コミットメッセージ**: **必ず日本語**で機能や修正内容を説明
  ```
  例: 座席管理機能の状態更新処理を追加
  例: 会計画面のレイアウト調整とバグ修正
  例: 印刷機能のESC/POSコマンド生成を改善
  ```
- **プルリクエスト**: タイトルと説明を**必ず日本語**で記述
  - タイトル: 機能の概要を簡潔に日本語で説明
  - 説明: 変更内容、影響範囲、テスト方法を日本語で詳述
- **コメント**: コードレビューやディスカッションは**必ず日本語**で実施
- **ブランチ名**: 英語で機能を表現（例: `feature/seat-management`, `fix/payment-calculation`）
- **作業記録管理**:
  - ❌ **禁止**: 作業記録用マークダウンファイルの作成（CHANGE_SUMMARY.md、IMPLEMENTATION_SUMMARY.md、VERIFICATION_GUIDE.md、*_INSTRUCTIONS.md、*_CHECKLIST.md等）
  - ✅ **推奨**: PRの説明欄、コメント機能、report_progressツールを使用して作業内容を記録
  - 理由: コミット履歴が作業記録ファイルで汚染され、実際のコード変更が見づらくなることを防ぐため

### 3. コードレビューポイント
- **業務ロジック**: 飲食店運営の実務に即しているか
- **パフォーマンス**: 同時アクセス、大量データ処理への対応
- **ユーザビリティ**: 操作性、エラーメッセージの分かりやすさ
- **保守性**: コードの可読性、拡張性

## よくある実装パターン

### 1. 座席状態更新
```java
@Service
@RequiredArgsConstructor
public class SeatService {
    
    private final SeatRepository seatRepository;
    private final SimpMessagingTemplate messagingTemplate;
    
    /**
     * 座席状態を更新し、WebSocketで通知
     */
    @Transactional
    public void updateSeatStatus(Integer seatId, SeatStatus status) {
        Seat seat = seatRepository.findById(seatId)
            .orElseThrow(() -> new EntityNotFoundException("座席が見つかりません"));
        
        seat.setStatus(status);
        seat.setUpdatedAt(LocalDateTime.now());
        seatRepository.save(seat);
        
        // WebSocketで全クライアントに通知
        messagingTemplate.convertAndSend("/topic/seats/" + seatId, seat);
    }
}
```

### 2. エラーハンドリング
```java
@ControllerAdvice
public class GlobalExceptionHandler {
    
    /**
     * 業務例外のハンドリング
     */
    @ExceptionHandler(BusinessException.class)
    public String handleBusinessException(BusinessException e, Model model) {
        model.addAttribute("errorMessage", e.getMessage());
        return "error/business-error";
    }
}
```

このシステムは日本の飲食店の実務に密接に関わるため、業務要件の理解と技術的な実装スキルの両方が重要です。常に店舗運営の効率化とスタッフの使いやすさを念頭に置いて開発を進めてください。