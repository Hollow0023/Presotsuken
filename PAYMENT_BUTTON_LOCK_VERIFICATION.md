# 会計ボタン排他制御機能 - 手動検証ガイド

## 概要
個別会計または割り勘会計の1度目の支払い後、他の会計方法をグレーアウトして選択できなくする機能の手動検証手順です。

## 前提条件
- アプリケーションが起動していること
- テストデータ（座席、メニュー、ユーザー、支払い種別）が登録されていること
- ブラウザの開発者ツールを開いてコンソールを確認できること

## テストシナリオ

### シナリオ1: 割り勘会計の排他制御

#### 手順
1. 座席を選択して注文を追加
2. 会計画面に遷移（`/payments?visitId=X`）
3. 初期状態を確認:
   - [ ] 「会計完了」ボタンが有効（通常の緑色）
   - [ ] 「割り勘会計」ボタンが有効（通常のオレンジ色）
   - [ ] 「個別会計」ボタンが有効（通常の青色）
4. 「割り勘会計」ボタンをクリック
5. 割り勘モーダルで以下を入力:
   - 分割人数: 3人
   - 現在の会計: 1人目
   - 支払い種別: 現金
   - 担当者: テスト担当者
   - 預かり金額: 十分な金額
6. 「会計実行」ボタンをクリック
7. 会計完了モーダルが表示されることを確認
8. 「閉じる」ボタンをクリック
9. 次の会計モーダルが自動的に開くことを確認
10. モーダルを閉じて、メインページのボタン状態を確認:
    - [ ] 「会計完了」ボタンが無効化（グレーアウト、透明度0.5）
    - [ ] 「割り勘会計」ボタンが有効（通常のオレンジ色）
    - [ ] 「個別会計」ボタンが無効化（グレーアウト、透明度0.5）
11. 無効化されたボタンをクリック:
    - [ ] 「会計完了」ボタンをクリック → 「割り勘会計が進行中です」のアラート表示
    - [ ] 「個別会計」ボタンをクリック → 「割り勘会計が進行中です」のアラート表示
12. 2人目、3人目の会計を完了させる
13. 最後の会計完了後、座席画面に自動遷移することを確認

#### 期待される結果
- 割り勘会計開始後、個別会計と通常会計ボタンが無効化される
- 割り勘会計ボタンは引き続き使用可能
- 無効化されたボタンはクリックするとアラートが表示される
- 全ての会計完了後、座席画面に遷移する

---

### シナリオ2: 個別会計の排他制御

#### 手順
1. 座席を選択して複数の商品を注文（例: ハンバーグ×2、サラダ×1）
2. 会計画面に遷移
3. 初期状態を確認:
   - [ ] 「会計完了」ボタンが有効
   - [ ] 「割り勘会計」ボタンが有効
   - [ ] 「個別会計」ボタンが有効
4. 「個別会計」ボタンをクリック
5. 個別会計モーダルで1つ目の商品を選択:
   - ハンバーグ: チェック、支払数量: 1
   - 支払い種別: 現金
   - 担当者: テスト担当者
   - 預かり金額: 十分な金額
6. 「会計実行」ボタンをクリック
7. 会計完了モーダルが表示されることを確認
8. 「閉じる」ボタンをクリック
9. ページがリロードされることを確認（開発者ツールのネットワークタブで確認可）
10. リロード後のボタン状態を確認:
    - [ ] 「会計完了」ボタンが無効化（グレーアウト、透明度0.5）
    - [ ] 「割り勘会計」ボタンが無効化（グレーアウト、透明度0.5）
    - [ ] 「個別会計」ボタンが有効（通常の青色）
11. 無効化されたボタンをクリック:
    - [ ] 「会計完了」ボタンをクリック → 「個別会計が進行中です」のアラート表示
    - [ ] 「割り勘会計」ボタンをクリック → 「個別会計が進行中です」のアラート表示
12. 残りの商品の会計を完了させる
13. 全ての商品の会計完了後、座席画面に自動遷移することを確認

#### 期待される結果
- 個別会計開始後、割り勘会計と通常会計ボタンが無効化される
- 個別会計ボタンは引き続き使用可能
- 無効化されたボタンはクリックするとアラートが表示される
- 全ての商品の会計完了後、座席画面に遷移する

---

### シナリオ3: 通常会計（排他制御なし）

#### 手順
1. 座席を選択して注文を追加
2. 会計画面に遷移
3. 初期状態を確認:
   - [ ] すべてのボタンが有効
4. 支払い種別と担当者を選択
5. 預かり金額を入力
6. 「会計完了」ボタンをクリック
7. 会計が完了し、座席画面に自動遷移することを確認

#### 期待される結果
- 通常会計では一括支払いのため、ボタンの無効化は発生しない
- 会計完了後、即座に座席画面に遷移する

---

### シナリオ4: ブラウザのリロード動作確認

#### 手順（割り勘会計の場合）
1. 割り勘会計を開始し、1人目の会計を完了
2. ボタンが無効化されていることを確認
3. ブラウザをリロード（F5 または Ctrl+R）
4. ページがリロードされ、ボタンの状態が保持されていることを確認:
   - [ ] 「会計完了」ボタンが無効化
   - [ ] 「個別会計」ボタンが無効化
   - [ ] 「割り勘会計」ボタンが有効

#### 手順（個別会計の場合）
1. 個別会計を開始し、1つ目の商品の会計を完了
2. ページがリロードされ、ボタンが無効化されていることを確認
3. ブラウザをリロード（F5 または Ctrl+R）
4. ページがリロードされ、ボタンの状態が保持されていることを確認:
   - [ ] 「会計完了」ボタンが無効化
   - [ ] 「割り勘会計」ボタンが無効化
   - [ ] 「個別会計」ボタンが有効

#### 期待される結果
- リロード後もボタンの無効化状態が正しく復元される
- paymentStatusがPARTIALであれば、適切なボタンが無効化される

---

## 開発者ツールでの確認項目

### JavaScriptコンソール
- エラーメッセージが表示されていないこと
- `/payments/{paymentId}/remaining` APIが正常に呼び出されていること
- `paymentStatus` 変数の値が正しいこと（PARTIAL または COMPLETED）

### ネットワークタブ
- 個別会計完了後、ページがリロードされていること（HTMLドキュメントのリクエスト）
- `/payments/{paymentId}/remaining` APIのレスポンスが正しいこと:
  ```json
  {
    "childPayments": [...],
    "isFullyPaid": false,
    ...
  }
  ```

### 要素の検査
- 無効化されたボタンの状態:
  - `disabled` 属性が設定されている
  - `style.opacity` が "0.5" に設定されている
  - `style.cursor` が "not-allowed" に設定されている
  - `onclick` 属性が削除されている
  - `data-original-onclick` 属性に元のonclick値が保存されている

---

## トラブルシューティング

### ボタンが無効化されない場合
1. JavaScriptコンソールでエラーがないか確認
2. `paymentStatus` の値を確認（コンソールで `paymentStatus` を入力）
3. `/payments/{paymentId}/remaining` APIのレスポンスを確認
4. ページのリロードを試す

### アラートが表示されない場合
1. ボタンの `onclick` 属性が削除されているか確認
2. イベントリスナーが正しく登録されているか確認（要素の検査）
3. JavaScriptコンソールでエラーがないか確認

### 会計完了後もボタンが無効のまま
1. `paymentStatus` が正しく "COMPLETED" に更新されているか確認
2. 座席画面への遷移が正常に動作しているか確認
3. ページがリロードされていないか確認（通常は遷移するため不要）

---

## 検証結果の記録

| シナリオ | 結果 | 備考 |
|---------|------|------|
| シナリオ1: 割り勘会計 | ☐ 合格 ☐ 不合格 | |
| シナリオ2: 個別会計 | ☐ 合格 ☐ 不合格 | |
| シナリオ3: 通常会計 | ☐ 合格 ☐ 不合格 | |
| シナリオ4: リロード動作 | ☐ 合格 ☐ 不合格 | |

検証日時: _______________
検証者: _______________

---

## 注意事項

1. この機能は会計履歴の不一致を防ぐための重要な機能です
2. 無効化されたボタンをクリックすると、適切なメッセージが表示されることを必ず確認してください
3. 会計の途中で他の会計方法に切り替えることはできません
4. 一度開始した会計方法（割り勘または個別）は、全ての会計が完了するまで継続する必要があります

## セキュリティ上の考慮事項

この実装では、フロントエンド（JavaScript）でボタンを無効化していますが、バックエンドでも適切な検証が行われています:
- `PaymentSplitService.processSplitPayment()` で割り勘会計の順序をチェック
- `PaymentSplitService.processIndividualPayment()` で商品の数量をチェック
- 既に開始されている会計方法との混在を防ぐロジックはバックエンドで実装されていることを確認してください

## 改善提案の受付

この機能で不十分だと思われる点があれば、以下の観点でフィードバックをお願いします:

1. **バックエンドでの検証**: 
   - 現在の実装では、フロントエンドでボタンを無効化していますが、バックエンドでも会計方法の混在をチェックする必要があるか？

2. **エラーハンドリング**: 
   - ユーザーがブラウザの「戻る」ボタンを押した場合の動作は適切か？
   - API呼び出しが失敗した場合のフォールバック処理は十分か？

3. **ユーザビリティ**: 
   - ボタンが無効化されていることがユーザーにわかりやすいか？
   - アラートメッセージは適切か？

4. **その他**: 
   - 会計の途中でページを離れた場合の処理は適切か？
   - 複数のタブで同じ会計画面を開いた場合の動作は適切か？
