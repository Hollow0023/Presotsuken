# アクセス制限まとめ

## 質問への回答

### Q1: レジ端末のアクセス制限は？
**A: 店舗名 + 店舗ID + IPアドレス制限**

- **ログイン画面**: `/login`
- **必要な情報**:
  - 店舗ID
  - 店舗名（パスワード代わり）
- **IP制限**: 
  - 事前に登録されたIPアドレスからのみログイン可能
  - IPアドレスが未登録の端末からはログイン不可（エラー: `terminalNotFound`）

**実装箇所**: `LoginController.login()` メソッド

### Q2: テーブル端末のアクセス制限は？
**A: 店舗名 + 店舗ID + IPアドレス制限（後付け）**

- **ログイン画面**: `/tableLogin`
- **必要な情報**:
  - 店舗ID
  - 店舗名
- **IP制限**: 
  - ログイン自体はIPチェックなし
  - `/visits/orderwait` アクセス時にIPアドレスをチェック
  - 登録されていない端末からのアクセスは例外発生（`RuntimeException("端末が見つかりません")`）

**実装箇所**: 
- ログイン: `TableLoginController.handleTableLogin()` メソッド
- IPチェック: `VisitController.orderWaitPage()` メソッド

### Q3: IPの制限はどうなっているか？
**A: Terminalテーブルで管理**

#### 端末登録の仕組み
- 管理画面 (`/admin/terminals`) で端末を登録
- 各端末には以下の情報を登録:
  - IPアドレス
  - 所属店舗
  - 座席（管理者端末の場合は不要）
  - 管理者フラグ

#### IPアドレスの取得方法
```java
// レジ端末（LoginController）
private String getClientIp(HttpServletRequest request) {
    String xfHeader = request.getHeader("X-Forwarded-For");
    String ip = (xfHeader == null) ? request.getRemoteAddr() : xfHeader.split(",")[0];
    
    // IPv6ループバックをIPv4に変換（テスト環境用）
    if ("0:0:0:0:0:0:0:1".equals(ip) || "::1".equals(ip)) {
        ip = "127.0.0.1";
    }
    
    return ip;
}

// テーブル端末（VisitController）
String ip = request.getRemoteAddr();
if ("0:0:0:0:0:0:0:1".equals(ip) || "::1".equals(ip)) {
    ip = "127.0.0.1";
}
```

#### データベース検索
```java
// IPアドレスと店舗IDで端末を検索
terminalRepository.findByIpAddressAndStore_StoreId(ipAddress, storeId)
```

## アクセス制限の全体像

```
┌─────────────────────────────────────────────────────┐
│           ログインチェックインターセプター              │
│     全てのページで Cookie に storeId があるか確認       │
│              （ログイン・静的ファイルは除外）            │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│                  レジ端末ログイン                      │
│            /login (LoginController)                 │
│                                                     │
│  1. 店舗ID + 店舗名で認証                             │
│  2. IPアドレスを取得（X-Forwarded-For対応）            │
│  3. Terminal テーブルで IP + 店舗ID を検索            │
│  4. 見つかればログイン成功                             │
│     - 管理者端末 → /seats                            │
│     - 一般端末 → /visits/orderwait                   │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│               テーブル端末ログイン                     │
│         /tableLogin (TableLoginController)          │
│                                                     │
│  1. 店舗ID + 店舗名で認証                             │
│  2. ログイン成功 → /visits/orderwait                  │
│  3. /visits/orderwait で IP チェック                 │
│     - IPアドレスを取得                                │
│     - Terminal テーブルで IP + 店舗ID を検索          │
│     - 見つからなければ例外発生                         │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│          管理者ページアクセスインターセプター             │
│       /admin/** で Cookie の adminFlag を確認         │
│              （管理者のみアクセス可能）                 │
└─────────────────────────────────────────────────────┘
```

## 重要なファイル

### コントローラー
- `LoginController.java` - レジ端末ログイン
- `TableLoginController.java` - テーブル端末ログイン
- `VisitController.java` - テーブル端末IPチェック
- `AdminTerminalController.java` - 端末管理

### インターセプター
- `LoginCheckInterceptor.java` - ログイン状態確認
- `AdminPageInterceptor.java` - 管理者権限確認

### エンティティ
- `Terminal.java` - 端末情報（IP、店舗、座席、管理者フラグ）

### リポジトリ
- `TerminalRepository.java` - 端末検索（IP + 店舗ID）

## セキュリティ上の注意

### 現在の実装
- ✅ IP制限により、登録済み端末のみアクセス可能
- ✅ 店舗名が事実上のパスワードとして機能
- ✅ Cookie で認証状態を管理（最大180日）
- ✅ インターセプターで権限チェック

### 改善の余地
- ⚠️ HTTPS未使用の場合、Cookie盗聴のリスク
- ⚠️ X-Forwarded-Forヘッダーの信頼性（プロキシ経由の場合）
- ⚠️ Cookieの改ざんで管理者権限を不正取得される可能性
- ⚠️ 店舗IDが推測可能な連番の場合のリスク

## まとめ

**レジ端末**: 店舗名 + 店舗ID + IP制限（事前チェック）  
**テーブル端末**: 店舗名 + 店舗ID + IP制限（後付けチェック）  
**IP制限**: Terminalテーブルで管理、店舗IDとIPアドレスの組み合わせで認証

どちらの端末も、事前に管理画面でIPアドレスを登録する必要があります。
