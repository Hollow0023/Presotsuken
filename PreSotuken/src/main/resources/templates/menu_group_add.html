<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/common-head :: common-head('メニューグループ管理', ${'menu-group-management.css'})">
</head>
<body>
    <!-- バーガーメニューボタン -->
    <div th:replace="~{fragments/burger-menu :: burger-button}"></div>
    
    <!-- バーガーメニュードロワー -->
    <div th:replace="~{fragments/burger-menu :: burger-drawer}"></div>

<script th:inline="javascript">
    // Thymeleafを使ってサーバーからstoreIdを受け取る
    const storeId = /*[[${storeId}]]*/ null; 
</script>

<div class="container">
  <h2>メニューグループ管理</h2>
  <a href="/">← トップに戻る</a>

  <hr>

  <div class="input-section">
    <h3>新しいグループを追加</h3>
    <input type="text" id="groupNameInput" placeholder="新しいグループ名を入力" maxlength="50" />
    <div class="checkbox-container">
	    <input type="checkbox" id="forAdminOnlyAdd" />
	    <label for="forAdminOnlyAdd">卓上端末から見えなくします</label>
 	 </div>
    <button id="addGroupButton" onclick="addGroup()">追加</button>
  </div>

  <hr>

  <div class="list-section">
    <h3>既存グループ一覧</h3>
    <ul id="menuGroupList" class="group-list">
      </ul>
    <p id="noGroupsMessage" class="d-none">メニューグループはまだありません。</p>
  </div>
</div>
<div id="toast"></div>

<!-- 削除確認モーダル -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <h3>メニューグループの削除</h3>
    <p>このメニューグループを削除しますか？</p>
    <p class="warning-text">
      <strong>注意:</strong><br>
      • 削除すると、このグループに属するメニューはどのグループにも属さない状態になります。<br>
      • この操作は元に戻せません。
    </p>
    <div class="modal-buttons">
      <button id="confirmDeleteButton" class="delete-button">削除</button>
      <button id="cancelDeleteButton" class="cancel-button">キャンセル</button>
    </div>
  </div>
</div>

<script>
  // DOM要素を取得
  const groupNameInput = document.getElementById('groupNameInput');
  const addGroupButton = document.getElementById('addGroupButton');
  const menuGroupList = document.getElementById('menuGroupList');
  const noGroupsMessage = document.getElementById('noGroupsMessage');
  const forAdminOnlyAddCheckbox = document.getElementById('forAdminOnlyAdd'); // ★追加：新規追加用のチェックボックス

  // グループデータの一時保存用（並び替え時に便利）
  let currentGroups = [];

  // --- 1. グループ一覧の取得と表示 ---
  async function fetchAndDisplayGroups() {
    if (storeId === null || isNaN(storeId)) {
      alert('店舗IDが取得できませんでした。ログインし直してください。');
      window.location.href = '/login'; // 必要に応じてログインページにリダイレクト
      return;
    }

    try {
      const response = await fetch(`/menu/group/api/list/${storeId}`); 
      if (!response.ok) {
        throw new Error('サーバーエラー: ' + response.status);
      }
      currentGroups = await response.json(); // 取得したグループデータを保存
      
      let maxSortOrder = 0;
      if (currentGroups.length > 0) {
          // currentGroupsの中で最も大きいsortOrderを探す
          maxSortOrder = Math.max(...currentGroups.map(group => group.sortOrder));
      }
      
      menuGroupList.innerHTML = ''; // 一旦リストをクリア

      if (currentGroups.length === 0) {
        noGroupsMessage.style.display = 'block';
      } else {
        noGroupsMessage.style.display = 'none';
        currentGroups.forEach(group => {
        appendGroupItem(group, maxSortOrder); // group と maxSortOrder の両方を渡す！
        });
      }
    } catch (error) {
      console.error('メニューグループの取得中にエラーが発生しました:', error);
      alert('メニューグループの取得に失敗しました。');
    }
  }

  // グループアイテムをリストに追加するヘルパー関数
  function appendGroupItem(group, maxSortOrder) {
    const li = document.createElement('li');
    li.className = 'group-item';
    li.dataset.groupId = group.groupId;
    li.dataset.sortOrder = group.sortOrder;
    li.dataset.forAdminOnly = group.forAdminOnly; // forAdminOnly の値もデータセットに追加


    const groupNameSpan = document.createElement('span');
    groupNameSpan.className = 'group-name';
    groupNameSpan.textContent = group.groupName;
    li.appendChild(groupNameSpan);
    
    // ここから追加：管理者限定バッジの表示
    if (group.forAdminOnly) {
        const adminBadge = document.createElement('span');
        adminBadge.className = 'admin-badge';
        adminBadge.textContent = '管理者限定';
        groupNameSpan.appendChild(adminBadge); // グループ名の隣に表示
    }

    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'group-actions';

    // 編集ボタン
    const editButton = document.createElement('button');
    editButton.textContent = '編集';
    // ★修正：enableEditMode に group を引数として渡す
    editButton.onclick = () => enableEditMode(li, groupNameSpan, editButton, group); 
    actionsDiv.appendChild(editButton);

    // 並び順変更ボタン (一番上/下では非活性化)
    const upButton = document.createElement('button');
    upButton.textContent = '▲';
    upButton.className = 'up-down-buttons';
    // sortOrderが1なら上には動かせない
    upButton.disabled = (group.sortOrder === 1); 
    upButton.onclick = () => moveGroup(group.groupId, 'up'); // ★ groupIdを渡す
    actionsDiv.appendChild(upButton);

    const downButton = document.createElement('button');
    downButton.textContent = '▼';
    downButton.className = 'up-down-buttons';
    // sortOrderが最大値（配列の長さ）なら下には動かせない
    downButton.disabled = (group.sortOrder === maxSortOrder);
    downButton.onclick = () => moveGroup(group.groupId, 'down'); // ★ groupIdを渡す
    actionsDiv.appendChild(downButton);

    li.appendChild(actionsDiv);
    menuGroupList.appendChild(li);
  }


  // --- 2. グループの追加 ---
  async function addGroup() {
    const groupName = groupNameInput.value.trim();
    if (!groupName) {
      alert("グループ名を入力してください");
      return;
    }

    if (storeId === null || isNaN(storeId)) {
      alert('店舗IDが取得できませんでした。');
      return;
    }
    
    const forAdminOnly = forAdminOnlyAddCheckbox.checked; // チェックボックスの状態を取得

    addGroupButton.disabled = true; // ボタンを無効化して多重送信防止

    try {
      const response = await fetch("/menu/group/api/add", { 
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ storeId: storeId, groupName: groupName, forAdminOnly: forAdminOnly })
      });

      const data = await response.json(); 

      if (!response.ok) { 
        if (data && data.error === "duplicate") { 
          alert("そのグループ名は既に存在しています。");
        } else if (data && data.error === "not_found") {
          alert("店舗情報が見つかりません。");
        } else {
          throw new Error("サーバーエラー: " + response.status + " - " + (data.message || "未知のエラー"));
        }
        return; 
      }

      // 成功時
      if (data.success) { 
        showToast("グループを追加しました！", 3000, 'success'); // alertをToastに変更
        groupNameInput.value = ''; // 入力フィールドをクリア
        forAdminOnlyAddCheckbox.checked = false; // ★追加：チェックボックスもクリア
        await fetchAndDisplayGroups(); // リストを再読み込みして最新の状態を表示
      } else {
        alert("グループの追加に失敗しました。");
      }
    } catch (err) {
      console.error('グループ追加中にエラーが発生しました:', err);
      alert("通信エラーが発生しました。");
    } finally {
      addGroupButton.disabled = false; // 処理が終わったらボタンを有効化
    }
  }


  // --- 3. グループ名の編集 ---
  // ★修正：groupData を引数に追加
  function enableEditMode(liElement, groupNameSpan, editButton, groupData) {
    const currentName = groupNameSpan.textContent;
    
    // 入力フィールドを作成
    const editInput = document.createElement('input');
    editInput.type = 'text';
    editInput.className = 'edit-input';
    editInput.value = groupData.groupName;
    editInput.maxLength = 50; 
    
    // 管理者限定チェックボックスを生成
    const adminCheckboxDiv = document.createElement('div');
    adminCheckboxDiv.className = 'admin-checkbox-div';

    const adminEditCheckbox = document.createElement('input');
    adminEditCheckbox.type = 'checkbox';
    adminEditCheckbox.id = `adminEditCheckbox-${groupData.groupId}`;
    adminEditCheckbox.checked = groupData.forAdminOnly;

    const adminLabel = document.createElement('label');
    adminLabel.htmlFor = adminEditCheckbox.id;
    adminLabel.textContent = '卓上端末から見えなくします';
    
    adminCheckboxDiv.appendChild(adminEditCheckbox);
    adminCheckboxDiv.appendChild(adminLabel);
    
    // div1: タイトル入力とチェックボックスを含むコンテナ
    const div1 = document.createElement('div');
    div1.className = 'edit-main-content';
    div1.appendChild(editInput);
    div1.appendChild(adminCheckboxDiv);
    
    // div2: ボタンコンテナ（保存、キャンセル、削除）
    const div2 = document.createElement('div');
    div2.className = 'edit-button-container';

    // 保存ボタン
    const saveButton = document.createElement('button');
    saveButton.textContent = '保存';
    saveButton.className = 'save-button';
    saveButton.onclick = () => saveGroup(liElement, editInput, groupNameSpan, saveButton, adminEditCheckbox);

    // キャンセルボタン
    const cancelButton = document.createElement('button');
    cancelButton.textContent = 'キャンセル';
    cancelButton.className = 'cancel-button';
    cancelButton.onclick = () => disableEditMode();
    
    // 削除ボタン
    const deleteButton = document.createElement('button');
    deleteButton.textContent = '削除';
    deleteButton.className = 'delete-button';
    deleteButton.onclick = () => showDeleteModal(groupData);
    
    div2.appendChild(saveButton);
    div2.appendChild(cancelButton);
    div2.appendChild(deleteButton);
    
    // div3: 上下矢印ボタン
    const div3 = document.createElement('div');
    div3.className = 'edit-arrow-container';
    
    // 既存の上下矢印ボタンを取得してクローン
    const actionsDiv = liElement.querySelector('.group-actions');
    if (actionsDiv) {
      const buttons = actionsDiv.querySelectorAll('.up-down-buttons');
      buttons.forEach(btn => {
        const clone = btn.cloneNode(true);
        // イベントを再設定
        clone.onclick = btn.onclick;
        div3.appendChild(clone);
      });
    }
    
    // div4: div2とdiv3をまとめる
    const div4 = document.createElement('div');
    div4.className = 'edit-controls-container';
    div4.appendChild(div2);
    div4.appendChild(div3);
    
    // 既存の構造をクリアして新しい構造を追加
    liElement.innerHTML = '';
    liElement.appendChild(div1);
    liElement.appendChild(div4);
    
    // フォーカスと全選択
    editInput.focus();
    editInput.select();
  }

  // グループ保存処理
  async function saveGroup(liElement, editInput, groupNameSpan, saveButton, adminEditCheckbox) {
    const groupId = liElement.dataset.groupId;
    const newName = editInput.value.trim();
    const cancelButton = saveButton.nextSibling;
    const newForAdminOnly = adminEditCheckbox.checked;

    if (!newName) {
      alert("グループ名を入力してください。");
      return;
    }

    saveButton.disabled = true;
    if (cancelButton) cancelButton.disabled = true;

    try {
      const response = await fetch(`/menu/group/api/edit/${groupId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ groupName: newName, storeId: storeId, forAdminOnly: newForAdminOnly }) 
      });

      const data = await response.json();

      if (!response.ok) {
        if (data && data.error === "duplicate") {
          alert("そのグループ名は既に存在しています。");
        } else if (data && data.error === "not_found") {
          alert("該当するグループが見つかりません。");
        } else if (response.status === 403) {
          alert("不正な操作です。");
        } else {
          throw new Error('サーバーエラー: ' + response.status + ' - ' + (data.message || '未知のエラー'));
        }
        return;
      }
      
      showToast("グループ名を更新しました！", 3000, 'success');
      await fetchAndDisplayGroups(); 
    } catch (error) {
      console.error('グループ名更新中にエラーが発生しました:', error);
      alert('グループ名の更新に失敗しました。');
    } finally {
      saveButton.disabled = false;
      if (cancelButton) cancelButton.disabled = false;
    }
  }

  // 編集モードを終了するヘルパー関数（簡略化版）
  function disableEditMode() {
    // 単純に全体を再描画
    fetchAndDisplayGroups();
  }


  // --- 4. 並び順の変更 ---
  async function moveGroup(groupId, direction) {
    if (storeId === null || isNaN(storeId)) {
      alert('店舗IDが取得できませんでした。');
      return;
    }

    document.querySelectorAll('.up-down-buttons').forEach(btn => btn.disabled = true);

    try {
      const response = await fetch('/menu/group/api/reorder', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          groupId: groupId, 
          direction: direction, 
          storeId: storeId 
        }) 
      });

      if (!response.ok) {
        const errorData = await response.json(); 
        throw new Error('サーバーエラー: ' + response.status + ' - ' + (errorData.message || '未知のエラー'));
      }
      
      showToast('並び順を更新しました！', 3000, 'success'); // ★追加：Toastのtype指定
      await fetchAndDisplayGroups(); // 更新後にリストを再読み込みして最新の並び順を表示
    } catch (error) {
      console.error('並び順更新中にエラーが発生しました:', error);
      alert('並び順の更新に失敗しました。' + error.message);
    } finally {
      // fetchAndDisplayGroups内でボタンのdisabled状態が再設定されるため、
      // ここでの処理はコメントアウトして大丈夫だよ。
      // document.querySelectorAll('.up-down-buttons').forEach(btn => btn.disabled = false);
    }
  }

  // --- 5. グループの削除 ---
  let groupToDelete = null;
  
  // 削除モーダルを表示
  function showDeleteModal(groupData) {
    groupToDelete = groupData;
    const modal = document.getElementById('deleteModal');
    modal.style.display = 'block';
  }
  
  // 削除モーダルを閉じる
  function hideDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.style.display = 'none';
    groupToDelete = null;
  }
  
  // 削除を実行
  async function deleteGroup() {
    if (!groupToDelete) return;
    
    const confirmButton = document.getElementById('confirmDeleteButton');
    const cancelButton = document.getElementById('cancelDeleteButton');
    
    confirmButton.disabled = true;
    cancelButton.disabled = true;
    
    try {
      const response = await fetch(`/menu/group/api/delete/${groupToDelete.groupId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ storeId: storeId })
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        if (data && data.error === "not_found") {
          alert("該当するグループが見つかりません。");
        } else if (response.status === 403) {
          alert("不正な操作です。");
        } else {
          throw new Error('サーバーエラー: ' + response.status + ' - ' + (data.message || '未知のエラー'));
        }
        return;
      }
      
      showToast("グループを削除しました", 3000, 'success');
      hideDeleteModal();
      await fetchAndDisplayGroups(); // リストを再読み込み
    } catch (error) {
      console.error('グループ削除中にエラーが発生しました:', error);
      alert('グループの削除に失敗しました。');
    } finally {
      confirmButton.disabled = false;
      cancelButton.disabled = false;
    }
  }
  
  // モーダルのボタンイベント設定
  document.getElementById('confirmDeleteButton').onclick = deleteGroup;
  document.getElementById('cancelDeleteButton').onclick = hideDeleteModal;
  
  // モーダルの外側をクリックしたら閉じる
  window.onclick = function(event) {
    const modal = document.getElementById('deleteModal');
    if (event.target === modal) {
      hideDeleteModal();
    }
  };

  // ページ読み込み時にグループ一覧を取得・表示
  document.addEventListener('DOMContentLoaded', fetchAndDisplayGroups);
  function showToast(message, duration = 2000, type = 'success') {
      const toast = document.getElementById("toast");
      if (!toast) {
          console.warn("Toast element not found.");
          alert(message);
          return;
      }
      toast.textContent = message;
      
      // スタイルをリセット
      toast.style.backgroundColor = '';
      toast.style.color = '';

      // タイプに応じたスタイルを設定
      if (type === 'error') {
          toast.style.backgroundColor = '#dc3545';
          toast.style.color = '#fff';
      } else if (type === 'success') {
          toast.style.backgroundColor = '#28a745';
          toast.style.color = '#fff';
      } else if (type === 'info') {
          toast.style.backgroundColor = '#007bff';
          toast.style.color = '#fff';
      }

      toast.style.display = "block";
      toast.style.opacity = "1";

      setTimeout(() => {
          toast.style.opacity = "0";
          setTimeout(() => {
              toast.style.display = "none";
          }, 500);
      }, duration);
  }
</script>

<!-- バーガーメニューのJavaScript -->
<div th:replace="~{fragments/burger-menu :: burger-menu-js}"></div>

</body>
</html>