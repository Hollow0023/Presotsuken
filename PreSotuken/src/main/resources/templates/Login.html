<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>店舗ログイン</title>
</head>
<body>
<h2>店舗ログイン</h2>

<form th:action="@{/login}" th:object="${store}" method="post"
      onsubmit="return validateLoginForm()">
	<label>店舗ID:
		<input type="number" th:field="*{storeId}" onblur="fetchUsersIfStoreMatches()" />
	</label><br>
    <label>店舗名: <input type="text" th:field="*{storeName}" onblur="fetchUsersIfStoreMatches()" /></label><br>
    
    

	<label>ユーザー:
		<select id="userSelect" onchange="saveUserIdToCookie()">
		    <option value="" disabled selected>選択してください</option>
		    <option th:each="user : ${users}" th:value="${user.userId}" th:text="${user.userName}"></option>
		</select>
	</label><br>
    <button type="submit">ログイン</button>
</form>

<div th:if="${error}" th:text="${error}" style="color:red;"></div>

<script>
	function fetchUsersIfStoreMatches() {
	    const storeId = document.querySelector('input[name="storeId"]').value;
	    const storeName = document.querySelector('input[name="storeName"]').value;
	
	    if (!storeId || !storeName) return;
	
	    fetch(`/api/stores/check?storeId=${storeId}&storeName=${encodeURIComponent(storeName)}`)
	        .then(res => res.json())
	        .then(data => {
	            if (data.valid) {
	                fetch(`/api/users/by-store?storeId=${storeId}`)
	                    .then(res => res.json())
	                    .then(users => {
	                        const select = document.getElementById("userSelect");
	                        select.innerHTML = '<option disabled selected>選択してください</option>';
	                        users.forEach(user => {
	                            const option = document.createElement("option");
	                            option.value = user.userId;
	                            option.text = user.userName;
	                            select.appendChild(option);
	                        });
	                    });
	            } else {
	                alert("店舗IDと店舗名が一致しません。");
	                document.getElementById("userSelect").innerHTML = '<option disabled selected>選択してください</option>';
	            }
	        });
	}

	
	
	function saveUserIdToCookie() {
	    const userId = document.getElementById("userSelect").value;
	    if (userId) {
	        document.cookie = `userId=${userId}; path=/`;
	    }
	}

	function validateLoginForm() {
	    const userId = document.getElementById("userSelect").value;
	    if (!userId) {
	        alert("ユーザーを選択してください。");
	        return false; // フォーム送信を止める
	    }
	    return true;
	}
</script>


</body>
</html>
