<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>会計履歴</title>
    <link rel="stylesheet" href="/css/payment-history.css">
</head>
<body>
<h1>会計履歴</h1>
<a href="/">← トップに戻る</a>
<table id="historyTable">
    <thead>
    <tr>
        <th>日時</th>
        <th>席</th>
        <th>税抜合計</th>
        <th>税込合計</th>
        <th>担当</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="payment : ${payments}" th:attr="data-payment-id=${payment.paymentId}">
        <td th:text="${#temporals.format(payment.paymentTime, 'yyyy-MM-dd HH:mm')}"></td>
        <td th:text="${payment.visit.seat.seatName}"></td>
        <td><span th:text="${#numbers.formatDecimal(subtotalMap[payment.paymentId],0,0)}"></span>円</td>
        <td><span th:text="${#numbers.formatDecimal(payment.total,0,0)}"></span>円</td>
        <td th:text="${payment.cashier != null ? payment.cashier.userName : ''}"></td>
    </tr>
    </tbody>
</table>
<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modalBody"></div>
    </div>
</div>
<script>
const modal = document.getElementById('detailModal');
const modalBody = document.getElementById('modalBody');
const closeBtn = modal.querySelector('.close');
let deletedDetailIds = [];

closeBtn.onclick = () => {
    modal.style.display = 'none';
};

window.onclick = event => {
    if (event.target === modal) {
        modal.style.display = 'none';
    }
};

function loadDetail(id, row) {
    deletedDetailIds = [];
    fetch(`/payments/history/${id}`)
        .then(res => res.json())
        .then(data => {
            let html = `<h2>会計詳細</h2>`;
            html += `<p>席: <select id="seatSelect">`;
            data.seats.forEach(s => {
                html += `<option value="${s.id}" ${s.id===data.seatId?'selected':''}>${s.name}</option>`;
            });
            html += `</select></p>`;
            html += `<p>支払い方法: <select id="paymentTypeSelect">`;
            data.paymentTypes.forEach(pt => {
                html += `<option value="${pt.id}" ${pt.id===data.paymentTypeId?'selected':''}>${pt.name}</option>`;
            });
            html += `</select></p>`;
            html += `<p>担当者: <select id="cashierSelect">`;
            data.users.forEach(u => {
                html += `<option value="${u.id}" ${u.id===data.cashierId?'selected':''}>${u.name}</option>`;
            });
            html += `</select></p>`;
            html += `<p>割引: <input type="number" id="discountInput" value="${data.discount || 0}">円</p>`;
            html += `<table id="detailTable"><thead><tr><th>商品</th><th>数量</th><th>税込小計</th><th>税抜小計</th><th></th></tr></thead><tbody>`;
            data.details.forEach(d => {
                const subIn = Math.round(d.subtotalWithTax);
                const subEx = Math.round(d.subtotalWithoutTax);
                html += `<tr data-detail-id="${d.paymentDetailId}" data-price="${d.price}" data-tax-rate="${d.taxRate}"><td>${d.menuName}</td><td><input type="number" class="qty-input" min="1" value="${d.quantity}"></td><td class="subtotal">${subIn}円</td><td class="subtotal-ex">${subEx}円</td><td><button type="button" class="delete-detail">削除</button></td></tr>`;
            });
            html += `</tbody></table>`;
            html += `<hr style="margin: 20px 0;">`;
            html += `<h3>領収書管理</h3>`;
            html += `<div id="receiptSection">読み込み中...</div>`;
            html += `<button id="saveChanges" class="save-btn">保存</button>`;
            modalBody.innerHTML = html;
            modal.style.display = 'block';

            // Load receipts for this payment
            loadReceipts(id);

            if (row) {
                row.querySelector('td:nth-child(2)').textContent = data.seatName;
                row.querySelector('td:nth-child(3)').textContent = `${Math.round(data.subtotal)}円`;
                row.querySelector('td:nth-child(4)').textContent = `${Math.round(data.total)}円`;
                row.querySelector('td:nth-child(5)').textContent = data.cashierName || '';
            }

            document.querySelectorAll('.delete-detail').forEach(btn => {
                btn.addEventListener('click', e => {
                    const tr = e.target.closest('tr');
                    deletedDetailIds.push(parseInt(tr.dataset.detailId));
                    tr.remove();
                });
            });

            document.querySelectorAll('.qty-input').forEach(input => {
                input.addEventListener('input', e => {
                    const tr = e.target.closest('tr');
                    const price = parseFloat(tr.dataset.price);
                    const taxRate = parseFloat(tr.dataset.taxRate);
                    const qty = parseInt(e.target.value) || 0;
                    const subEx = price * qty;
                    const subIn = subEx * (1 + taxRate);
                    tr.querySelector('.subtotal').textContent = `${Math.round(subIn)}円`;
                    tr.querySelector('.subtotal-ex').textContent = `${Math.round(subEx)}円`;
                });
            });

            document.getElementById('saveChanges').addEventListener('click', () => {
                const payload = {
                    seatId: parseInt(document.getElementById('seatSelect').value),
                    paymentTypeId: parseInt(document.getElementById('paymentTypeSelect').value),
                    cashierId: parseInt(document.getElementById('cashierSelect').value),
                    discount: parseFloat(document.getElementById('discountInput').value) || 0,
                    details: []
                };
                document.querySelectorAll('#detailTable tbody tr').forEach(tr => {
                    payload.details.push({
                        paymentDetailId: parseInt(tr.dataset.detailId),
                        quantity: parseInt(tr.querySelector('.qty-input').value)
                    });
                });
                deletedDetailIds.forEach(id => {
                    payload.details.push({paymentDetailId: id, delete: true});
                });
                fetch(`/payments/history/${id}/edit`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                }).then(res => {
                    if (res.ok) {
                        loadDetail(id, row);
                    }
                });
            });
        });
}

document.querySelectorAll('#historyTable tbody tr').forEach(row => {
    row.addEventListener('click', () => {
        const id = row.dataset.paymentId;
        loadDetail(id, row);
    });
});

function loadReceipts(paymentId) {
    Promise.all([
        fetch(`/receipts/payment/${paymentId}`).then(res => res.json()),
        fetch(`/receipts/payment/${paymentId}/remaining`).then(res => res.json())
    ]).then(([receipts, remaining]) => {
        let html = `<p>残高: 10%対象 ${remaining.remaining10}円、8%対象 ${remaining.remaining8}円、合計 ${remaining.totalRemaining}円</p>`;
        
        if (receipts.length > 0) {
            html += `<h4>発行済み領収書</h4>`;
            html += `<table style="width:100%; margin-top:10px;">`;
            html += `<thead><tr><th>領収書番号</th><th>金額</th><th>発行者</th><th>再印字回数</th><th>状態</th><th>操作</th></tr></thead>`;
            html += `<tbody>`;
            receipts.forEach(r => {
                const status = r.voided ? '取消済' : '有効';
                html += `<tr>`;
                html += `<td>${r.receiptNo}</td>`;
                html += `<td>${r.totalAmount}円</td>`;
                html += `<td>${r.issuedByUserName}</td>`;
                html += `<td>${r.reprintCount}</td>`;
                html += `<td>${status}</td>`;
                html += `<td>`;
                if (!r.voided) {
                    html += `<button onclick="reprintReceipt(${r.receiptId})">再印字</button> `;
                    html += `<button onclick="voidReceipt(${r.receiptId})">取消</button>`;
                }
                html += `</td>`;
                html += `</tr>`;
            });
            html += `</tbody></table>`;
        }
        
        if (parseFloat(remaining.totalRemaining) > 0) {
            html += `<button onclick="openReceiptIssueModal(${paymentId}, ${remaining.totalRemaining})" style="margin-top:10px;">新規領収書発行</button>`;
        }
        
        document.getElementById('receiptSection').innerHTML = html;
    }).catch(err => {
        document.getElementById('receiptSection').innerHTML = '<p>領収書情報の読み込みに失敗しました</p>';
        console.error('Error loading receipts:', err);
    });
}

function openReceiptIssueModal(paymentId, totalRemaining) {
    const html = `
        <div id="receiptIssueModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
            <div style="background:white;padding:20px;border-radius:8px;min-width:400px;">
                <h3>領収書発行</h3>
                <div style="margin-bottom:15px;">
                    <button id="fullTab" class="tab-btn active" onclick="switchTab('full')">全額</button>
                    <button id="amountTab" class="tab-btn" onclick="switchTab('amount')">金額指定</button>
                </div>
                <div id="fullContent" class="tab-content" style="display:block;">
                    <p>残高全額で発行します</p>
                    <p>金額: ${totalRemaining}円</p>
                    <button onclick="issueReceiptFromHistory(${paymentId}, 'FULL', null)">発行</button>
                </div>
                <div id="amountContent" class="tab-content" style="display:none;">
                    <p>金額を指定して発行します</p>
                    <p>残高: ${totalRemaining}円</p>
                    <label>発行金額:</label>
                    <input type="number" id="specAmount" min="0" max="${totalRemaining}"> 円
                    <button onclick="issueReceiptFromHistory(${paymentId}, 'AMOUNT', document.getElementById('specAmount').value)">発行</button>
                </div>
                <button onclick="closeReceiptIssueModal()" style="margin-top:10px;">キャンセル</button>
            </div>
        </div>
        <style>
            .tab-btn { padding:8px 16px; margin-right:5px; border:1px solid #ccc; background:#f0f0f0; cursor:pointer; }
            .tab-btn.active { background:#4caf50; color:white; }
        </style>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
}

function closeReceiptIssueModal() {
    const modal = document.getElementById('receiptIssueModal');
    if (modal) modal.remove();
}

function switchTab(tab) {
    if (tab === 'full') {
        document.getElementById('fullTab').classList.add('active');
        document.getElementById('amountTab').classList.remove('active');
        document.getElementById('fullContent').style.display = 'block';
        document.getElementById('amountContent').style.display = 'none';
    } else {
        document.getElementById('fullTab').classList.remove('active');
        document.getElementById('amountTab').classList.add('active');
        document.getElementById('fullContent').style.display = 'none';
        document.getElementById('amountContent').style.display = 'block';
    }
}

function issueReceiptFromHistory(paymentId, mode, amount) {
    // Get user ID from cookie or prompt
    const userId = getCookie('userId') || prompt('担当者IDを入力してください');
    if (!userId) {
        alert('担当者IDが必要です');
        return;
    }
    
    if (mode === 'AMOUNT' && (!amount || parseFloat(amount) <= 0)) {
        alert('有効な金額を入力してください');
        return;
    }
    
    const idempotencyKey = `${paymentId}-${Date.now()}-${Math.random()}`;
    
    fetch('/receipts/issue', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            paymentId: parseInt(paymentId),
            mode: mode,
            amount: amount ? parseFloat(amount) : null,
            issuedByUserId: parseInt(userId),
            idempotencyKey: idempotencyKey
        })
    }).then(res => {
        if (res.ok) return res.json();
        throw new Error('領収書の発行に失敗しました');
    }).then(data => {
        alert('領収書を発行しました\n領収書番号: ' + data.receiptNo);
        closeReceiptIssueModal();
        loadReceipts(paymentId);
    }).catch(err => {
        console.error('Error:', err);
        alert('領収書の発行中にエラーが発生しました。');
    });
}

function reprintReceipt(receiptId) {
    const userId = getCookie('userId') || prompt('担当者IDを入力してください');
    if (!userId) {
        alert('担当者IDが必要です');
        return;
    }
    
    if (!confirm('この領収書を再印字しますか？')) return;
    
    fetch(`/receipts/${receiptId}/reprint`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({userId: parseInt(userId)})
    }).then(res => {
        if (res.ok) return res.json();
        throw new Error('再印字に失敗しました');
    }).then(data => {
        alert('領収書を再印字しました');
        const paymentId = data.paymentId;
        loadReceipts(paymentId);
    }).catch(err => {
        console.error('Error:', err);
        alert('再印字中にエラーが発生しました。');
    });
}

function voidReceipt(receiptId) {
    const userId = getCookie('userId') || prompt('担当者IDを入力してください');
    if (!userId) {
        alert('担当者IDが必要です');
        return;
    }
    
    if (!confirm('この領収書を取り消しますか？この操作は元に戻せません。')) return;
    
    fetch(`/receipts/${receiptId}/void`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({userId: parseInt(userId)})
    }).then(res => {
        if (!res.ok) throw new Error('取消に失敗しました');
        alert('領収書を取り消しました');
        // Reload receipts - need to get payment ID first
        const rows = document.querySelectorAll('#historyTable tbody tr');
        rows.forEach(row => {
            if (row.style.backgroundColor) {
                const paymentId = row.dataset.paymentId;
                loadReceipts(paymentId);
            }
        });
    }).catch(err => {
        console.error('Error:', err);
        alert('取消中にエラーが発生しました。');
    });
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}
</script>
</body>
</html>
