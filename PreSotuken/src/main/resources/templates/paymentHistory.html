<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>会計履歴</title>
    <link rel="stylesheet" href="/css/payment-history.css">
    <!-- バーガーメニューのCSS -->
    <link rel="stylesheet" href="/css/components/navigation.css">
</head>
<body>
    <!-- バーガーメニューボタン -->
    <div th:replace="~{fragments/burger-menu :: burger-button}"></div>
    
    <!-- バーガーメニュードロワー -->
    <div th:replace="~{fragments/burger-menu :: burger-drawer}"></div>
    
<h1>会計履歴</h1>
<a href="/">← トップに戻る</a>

<!-- フィルタ選択プルダウン -->
<div style="margin: 20px 0;">
    <label for="filterSelect">表示する履歴: </label>
    <select id="filterSelect" onchange="changeFilter()">
        <option value="active" th:selected="${currentFilter == 'active' or currentFilter == null}">会計履歴</option>
        <option value="cancelled" th:selected="${currentFilter == 'cancelled'}">キャンセル</option>
    </select>
</div>

<table id="historyTable">
    <thead>
    <tr>
        <th>状態</th>
        <th>日時</th>
        <th>席</th>
        <th>税抜合計</th>
        <th>税込合計</th>
        <th>担当</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="payment : ${payments}"
        th:attr="data-payment-id=${payment.paymentId}"
        th:classappend="${payment.visitCancel or payment.cancel} ? ' cancelled-row' : ''">
        <td class="status-cell">
            <span th:if="${payment.visitCancel or payment.cancel}">削除済</span>
            <span th:if="${!payment.visitCancel and !payment.cancel and payment.totalSplits != null and payment.totalSplits > 0}">割</span>
        </td>
        <td th:text="${#temporals.format(payment.paymentTime, 'yyyy-MM-dd HH:mm')}"></td>
        <td th:text="${payment.visit.seat.seatName}"></td>
        <td><span th:text="${#numbers.formatDecimal(subtotalMap[payment.paymentId],0,0)}"></span>円</td>
        <td><span th:text="${#numbers.formatDecimal(payment.total,0,0)}"></span>円</td>
        <td th:text="${payment.cashier != null ? payment.cashier.userName : ''}"></td>
        <td>
            <a th:href="@{/payments/history/detail(paymentId=${payment.paymentId})}" 
               style="color: #4caf50; text-decoration: none; font-weight: bold;">
                領収書管理
            </a>
        </td>
    </tr>
    </tbody>
</table>
<script>
// フィルタ変更時にページをリロード
function changeFilter() {
    const filterValue = document.getElementById('filterSelect').value;
    window.location.href = '/payments/history?filter=' + filterValue;
}
</script>

<!-- バーガーメニューのJavaScript -->
<div th:replace="~{fragments/burger-menu :: burger-menu-js}"></div>
</body>
</html>
