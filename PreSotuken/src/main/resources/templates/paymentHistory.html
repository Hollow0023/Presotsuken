<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>会計履歴</title>
    <link rel="stylesheet" href="/css/payment-history.css">
    <!-- バーガーメニューのCSS -->
    <link rel="stylesheet" href="/css/components/navigation.css">
</head>
<body>
    <!-- バーガーメニューボタン -->
    <div th:replace="~{fragments/burger-menu :: burger-button}"></div>
    
    <!-- バーガーメニュードロワー -->
    <div th:replace="~{fragments/burger-menu :: burger-drawer}"></div>
    
<h1>会計履歴</h1>
<a href="/">← トップに戻る</a>

<!-- フィルタ選択プルダウン -->
<div style="margin: 20px 0;">
    <label for="filterSelect">表示する履歴: </label>
    <select id="filterSelect" onchange="changeFilter()">
        <option value="active" th:selected="${currentFilter == 'active' or currentFilter == null}">会計履歴</option>
        <option value="cancelled" th:selected="${currentFilter == 'cancelled'}">キャンセル</option>
    </select>
</div>

<table id="historyTable">
    <thead>
    <tr>
        <th>状態</th>
        <th>日時</th>
        <th>席</th>
        <th>税抜合計</th>
        <th>税込合計</th>
        <th>担当</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="payment : ${payments}"
        th:attr="data-payment-id=${payment.paymentId}"
        th:classappend="${payment.visitCancel or payment.cancel} ? ' cancelled-row' : ''">
        <td class="status-cell">
            <span th:if="${payment.visitCancel or payment.cancel}">削除済</span>
            <span th:if="${!(payment.visitCancel or payment.cancel) and payment.parentPayment == null and payment.totalSplits != null}">割り勘元</span>
            <span th:if="${!(payment.visitCancel or payment.cancel) and payment.parentPayment != null}">割り勘先</span>
        </td>
        <td th:text="${payment.paymentTime != null ? #temporals.format(payment.paymentTime, 'yyyy-MM-dd HH:mm') : ''}"></td>
        <td th:text="${payment.visit.seat.seatName}"></td>
        <td><span th:text="${#numbers.formatDecimal(subtotalMap[payment.paymentId],0,0)}"></span>円</td>
        <td><span th:text="${payment.total != null ? #numbers.formatDecimal(payment.total,0,0) : '0'}"></span>円</td>
        <td th:text="${payment.cashier != null ? payment.cashier.userName : ''}"></td>
        <td>
            <a th:href="@{/payments/history/detail(paymentId=${payment.paymentId})}" 
               style="color: #4caf50; text-decoration: none; font-weight: bold;">
                会計詳細
            </a>
        </td>
    </tr>
    </tbody>
</table>
<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modalBody"></div>
    </div>
</div>
<script>
const modal = document.getElementById('detailModal');
const modalBody = document.getElementById('modalBody');
const closeBtn = modal.querySelector('.close');
let deletedDetailIds = [];

// フィルタ変更時にページをリロード
function changeFilter() {
    const filterValue = document.getElementById('filterSelect').value;
    window.location.href = '/payments/history?filter=' + filterValue;
}

function updateRowSubtotal(tr) {
    if (!tr) return;
    const price = parseFloat(tr.dataset.price) || 0;
    const taxRate = parseFloat(tr.dataset.taxRate) || 0;
    const qtyInput = tr.querySelector('.qty-input');
    const discountInput = tr.querySelector('.discount-input');
    const qty = qtyInput ? (parseInt(qtyInput.value) || 0) : 0;
    let discountValue = discountInput ? parseFloat(discountInput.value) : 0;
    if (!isFinite(discountValue) || discountValue < 0) {
        discountValue = 0;
    }
    const subtotalBeforeDiscount = price * qty;
    if (discountValue > subtotalBeforeDiscount) {
        discountValue = subtotalBeforeDiscount;
    }
    if (discountInput) {
        discountInput.value = Math.round(discountValue);
    }
    const subtotalEx = Math.max(subtotalBeforeDiscount - discountValue, 0);
    const subtotalIn = subtotalEx * (1 + taxRate);
    const subtotalCell = tr.querySelector('.subtotal');
    const subtotalExCell = tr.querySelector('.subtotal-ex');
    if (subtotalCell) {
        subtotalCell.textContent = `${Math.round(subtotalIn)}円`;
    }
    if (subtotalExCell) {
        subtotalExCell.textContent = `${Math.round(subtotalEx)}円`;
    }
}

closeBtn.onclick = () => {
    modal.style.display = 'none';
};

window.onclick = event => {
    if (event.target === modal) {
        modal.style.display = 'none';
    }
};

function loadDetail(id, row) {
    deletedDetailIds = [];
    fetch(`/payments/history/${id}`)
        .then(res => res.json())
        .then(data => {
            const isCancelled = data.cancel === true;
            const statusText = isCancelled ? '削除済み' : '有効';
            const statusClass = isCancelled ? 'status-cancelled' : 'status-active';

            let html = `<h2>会計詳細</h2>`;
            html += `<p>状態: <span id="cancelStatus" class="cancel-status ${statusClass}">${statusText}</span></p>`;
            html += `<button id="toggleCancel" class="cancel-toggle-btn">${isCancelled ? '復元する' : '削除する'}</button>`;
            html += `<p>席: <select id="seatSelect">`;
            data.seats.forEach(s => {
                html += `<option value="${s.id}" ${s.id===data.seatId?'selected':''}>${s.name}</option>`;
            });
            html += `</select></p>`;
            html += `<p>支払い方法: <select id="paymentTypeSelect">`;
            data.paymentTypes.forEach(pt => {
                html += `<option value="${pt.id}" ${pt.id===data.paymentTypeId?'selected':''}>${pt.name}</option>`;
            });
            html += `</select></p>`;
            html += `<p>担当者: <select id="cashierSelect">`;
            data.users.forEach(u => {
                html += `<option value="${u.id}" ${u.id===data.cashierId?'selected':''}>${u.name}</option>`;
            });
            html += `</select></p>`;
            html += `<p>割引: <input type="number" id="discountInput" value="${data.discount || 0}">円</p>`;
            html += `<table id="detailTable"><thead><tr><th>商品</th><th>数量</th><th>割引額</th><th>税込小計</th><th>税抜小計</th><th></th></tr></thead><tbody>`;
            data.details.forEach(d => {
                const discount = d.discount || 0;
                const subIn = Math.round(d.subtotalWithTax);
                const subEx = Math.round(d.subtotalWithoutTax);
                html += `<tr data-detail-id="${d.paymentDetailId}" data-price="${d.price}" data-tax-rate="${d.taxRate}"><td>${d.menuName}</td><td><input type="number" class="qty-input" min="1" value="${d.quantity}"></td><td><input type="number" class="discount-input" min="0" step="1" value="${discount}"></td><td class="subtotal">${subIn}円</td><td class="subtotal-ex">${subEx}円</td><td><button type="button" class="delete-detail">削除</button></td></tr>`;
            });
            html += `</tbody></table>`;
            html += `<button id="saveChanges" class="save-btn">保存</button>`;
            modalBody.innerHTML = html;
            modal.style.display = 'block';

            if (row) {
                const statusCell = row.querySelector('td:nth-child(1)');
                if (statusCell) {
                    statusCell.textContent = isCancelled ? '削除済' : '';
                }
                row.classList.toggle('cancelled-row', isCancelled);
                row.querySelector('td:nth-child(3)').textContent = data.seatName;
                row.querySelector('td:nth-child(4)').textContent = `${Math.round(data.subtotal)}円`;
                row.querySelector('td:nth-child(5)').textContent = `${Math.round(data.total)}円`;
                row.querySelector('td:nth-child(6)').textContent = data.cashierName || '';
            }

            document.querySelectorAll('.delete-detail').forEach(btn => {
                btn.addEventListener('click', e => {
                    const tr = e.target.closest('tr');
                    deletedDetailIds.push(parseInt(tr.dataset.detailId));
                    tr.remove();
                });
            });

            document.querySelectorAll('.qty-input').forEach(input => {
                input.addEventListener('input', e => {
                    const tr = e.target.closest('tr');
                    updateRowSubtotal(tr);
                });
            });

            document.querySelectorAll('.discount-input').forEach(input => {
                input.addEventListener('input', e => {
                    const tr = e.target.closest('tr');
                    updateRowSubtotal(tr);
                });
            });

            document.querySelectorAll('#detailTable tbody tr').forEach(tr => updateRowSubtotal(tr));

            document.getElementById('saveChanges').addEventListener('click', () => {
                const payload = {
                    seatId: parseInt(document.getElementById('seatSelect').value),
                    paymentTypeId: parseInt(document.getElementById('paymentTypeSelect').value),
                    cashierId: parseInt(document.getElementById('cashierSelect').value),
                    discount: parseFloat(document.getElementById('discountInput').value) || 0,
                    details: []
                };
                document.querySelectorAll('#detailTable tbody tr').forEach(tr => {
                    payload.details.push({
                        paymentDetailId: parseInt(tr.dataset.detailId),
                        quantity: parseInt(tr.querySelector('.qty-input').value),
                        discount: parseFloat(tr.querySelector('.discount-input').value) || 0
                    });
                });
                deletedDetailIds.forEach(id => {
                    payload.details.push({paymentDetailId: id, delete: true});
                });
                fetch(`/payments/history/${id}/edit`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                }).then(res => {
                    if (res.ok) {
                        loadDetail(id, row);
                    }
                });
            });

            const toggleBtn = document.getElementById('toggleCancel');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    fetch(`/payments/history/${id}/cancel`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({cancel: !isCancelled})
                    }).then(res => {
                        if (res.ok) {
                            loadDetail(id, row);
                        }
                    });
                });
            }
        });
}

document.querySelectorAll('#historyTable tbody tr').forEach(row => {
    row.addEventListener('click', (e) => {
        // リンクをクリックした場合は詳細モーダルを開かない
        if (e.target.tagName === 'A' || e.target.closest('a')) {
            return;
        }
        const id = row.dataset.paymentId;
        loadDetail(id, row);
    });
});
</script>

<!-- バーガーメニューのJavaScript -->
<div th:replace="~{fragments/burger-menu :: burger-menu-js}"></div>
</body>
</html>
