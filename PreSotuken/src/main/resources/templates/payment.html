<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>会計詳細</title>
	<style>
		body {
			font-family: sans-serif;
			padding: 0;
			margin: 0;
			display: flex;
			height: 100svh;
			overflow: hidden; 
		}

		.left-panel {
			flex: 1;
			border-right: 1px solid #ccc;
			overflow: auto;
			padding: 20px;
		}

		.right-panel {
			width: 300px;
			padding: 20px;
			background-color: #f9f9f9;
			height:100vh;
			overflow-x: scroll;
		}

		.section , .onclickSection{
			display: flex;
			align-items:center;
			margin-bottom: 15px;
			
			border-bottom: 1px solid #ccc;
			padding-bottom: 5px;
		}

		.onclickSection:hover {
			background-color: #eee;
			cursor: pointer;
		}

		.onclickSection label , .section label {
			font-weight: bold;
			display: inline-block;
			width: 80px;
			
		}

		.onclickSection span, .section p {
			display: inline-block;
			min-width:50px;
			margin-left: auto;
		}
		.onclickSection span{
			color: rgb(0, 79, 225);
			font-weight: bold;
			margin-left: auto;
			width:auto;
		}
		.onclickSection p{
			width: 10px;
			margin:0;
			
			margin-right: 15px;
			color:#bbbbbb;
		}


		button.full-btn {
			display: block;
			width: 100%;
			padding: 10px;
			margin-top: 10px;
			border: none;
			border-radius: 4px;
			font-size: 16px;
			cursor: pointer;
		}

		button.purple { background-color: #d09eff; color: white; }
		button.green { background-color: #4caf50; color: white; }
		button.red { background-color: #f44336; color: white; margin-bottom:40px}

		.modal {
			display: none;
			position: fixed;
			z-index: 20;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
		}

		.modal-content {
			background: white;
			padding: 20px;
			margin: 10% auto;
			width: 400px;
			border-radius: 8px;
		}

		.tab-container {
			display: flex;
			margin-bottom: 15px;
		}

		.tab-btn {
			flex: 1;
			padding: 10px;
			background-color: #f0f0f0;
			border: 1px solid #ccc;
			cursor: pointer;
		}

		.tab-btn.active {
			background-color: #4caf50;
			color: white;
			border-color: #4caf50;
		}

		.tab-content {
			display: none;
			padding: 15px 0;
		}

		.tab-content.active {
			display: block;
		}
	</style>
</head>
<body>
	<div class="left-panel">
		<h2>注文</h2>
		 <a href="/">← トップに戻る</a>
		<input type="hidden" id="paymentId" th:value="${payment.paymentId}" />
		<input type="hidden" id="paymentStatus" th:value="${payment.paymentStatus}" />
		<input type="hidden" id="totalSplits" th:value="${payment.totalSplits}" />
		<table border="1" style="width:100%">
			<thead>
				<tr>
					<th>商品</th>
					<th>単価</th>
					<th>数量</th>
					<th>税率</th>
					<th>小計</th>
					<th>割引</th>
					<th>合計</th> </tr>
			</thead>
			<tbody id="detailBody">
				<tr th:each="detail, stat : ${details}" 
					th:onclick="|openDetailDiscountModal(${stat.index})|" 
					th:data-paymentdetail-id="${detail.paymentDetailId}" style="cursor: pointer;">
					<td th:text="${detail.menu.menuName}"></td>
					<td th:text="${#numbers.formatDecimal(detail.menu.price, 0, 0)} + '円'"></td>
					<td th:text="${detail.quantity}"></td>
					<td th:text="${#numbers.formatDecimal(detail.taxRate.rate * 100, 0, 0)} + '%' "></td>
					<td th:text="${#numbers.formatDecimal(detail.menu.price * detail.quantity + detail.menu.price * detail.quantity * detail.taxRate.rate, 0, 0)} + '円'"></td>
					<td th:id="${'detailDiscountAmount_' + stat.index}" style="color: red;">0円</td>
					<td th:id="${'detailTotalAfterDiscount_' + stat.index}"></td>
				</tr>
			</tbody>
		</table>
	</div>
	<div class="right-panel">
		<div class="section">
			<label>状態</label><p>注文受付中</p>
		</div>
		<div class="onclickSection" onclick="openModal('peopleModal')">
			<label>人数</label><span id="people" th:text="${visit.numberOfPeople} + '名'"></span><p>></p>
		</div>
		<div class="section">
			<label>小計</label><p id="subtotal" th:text="${subtotal} + '円'">0円</p>
		</div>
		<div class="onclickSection" onclick="openModal('discountModal')">
			<label>値引</label><span id="discount">0円</span><p>></p>
		</div>
		<div class="section">
			<label>合計</label><p id="total">0円</p>
		</div>
		<div class="onclickSection" onclick="openModal('receivedModal')">
			<label>預かり</label><span id="receivedDisplay">0円</span><p>></p>
		</div>
		<div class="section">
			<label>お釣り</label><p id="change">0円</p>
		</div>

		<div class="section">
			<label>種別</label>
			<select id="paymentTypeSelect">
				<option value="">選択してください</option>
				<option th:each="type : ${paymentTypeList}" th:value="${type.typeId}" th:text="${type.typeName}"></option>
			</select>
		</div>
		<div class="section">
			<label>担当者</label>
			<select id="staffSelect">
				<option value="">選択してください</option>
				<option th:each="user : ${userList}" th:value="${user.userId}" th:text="${user.userName}"></option>
			</select>
		</div>

		<div class="section">
			<label>領収書印刷</label>
			<input type="checkbox" id="receiptPrintCheckbox" style="width: auto; height: auto;">
		</div>

		<button class="full-btn purple">会計前レシート</button>
		<button class="full-btn green" onclick="finalizePayment()">会計完了</button>
		<button class="full-btn" style="background-color: #FF9800; color: white;" onclick="openSplitPaymentModal()">割り勘会計</button>
		<button class="full-btn" style="background-color: #2196F3; color: white;" onclick="openIndividualPaymentModal()">個別会計</button>
		<button class="full-btn red" onclick="goBackToSeats()">取引中止</button>
	</div>

	<div id="peopleModal" class="modal">
		<div class="modal-content">
			<h3>人数を編集</h3>
			<input type="number" id="peopleInput" min="1" value="1"> 名
			<button onclick="applyPeopleCount()">保存</button> 
			<button onclick="closeModal('peopleModal')">閉じる</button>
		</div>
	</div>

	<!-- 領収書発行モーダル -->
	<div id="receiptModal" class="modal">
		<div class="modal-content" style="width: 500px;">
			<h3>領収書発行</h3>
			<div class="tab-container">
				<button class="tab-btn active" onclick="switchReceiptTab('full')">全額</button>
				<button class="tab-btn" onclick="switchReceiptTab('amount')">金額指定</button>
			</div>
			
			<div id="fullTab" class="tab-content active">
				<p>会計全額で領収書を発行します。</p>
				<p>発行額: <span id="fullAmount">0</span>円</p>
			</div>
			
			<div id="amountTab" class="tab-content">
				<p>発行金額を指定してください。</p>
				<label>発行額:</label>
				<input type="number" id="receiptAmountInput" min="0" placeholder="発行額を入力">円
				<p style="font-size: 0.9em; color: #666;">
					残高: <span id="remainingAmount">0</span>円
				</p>
			</div>
			
			<button onclick="issueReceipt()" style="margin-top: 10px;">発行</button>
			<button onclick="closeModal('receiptModal')">キャンセル</button>
		</div>
	</div>

	<div id="discountModal" class="modal">
		<div class="modal-content">
			<h3>割引を入力</h3>
			<p class="tyuuki">*割増は-を付ける</p>
			<label>割引金額:</label><input type="number" id="discountInput" min="0" placeholder="割引金額を入力"><br>
			<label>割引理由:</label><input type="text" id="discountReasonInput" placeholder="割引理由を入力"><br>
			<button onclick="applyDiscount()">保存</button>
		</div>
	</div>

	<div id="receivedModal" class="modal">
		<div class="modal-content">
			<h3>預かり金を入力</h3>
			<input type="number" id="receivedInput" placeholder="預かり額 (例: 10000)" oninput="updateReceived()"> 円
			<button onclick="closeModal('receivedModal')">閉じる</button>
		</div>
	</div>

	<!-- 会計完了モーダル（割り勘・個別会計用） -->
	<div id="paymentCompleteModal" class="modal" style="z-index: 30;">
		<div class="modal-content" style="width: 400px;">
			<h3>会計完了</h3>
			<div style="margin: 20px 0; font-size: 1.2em;">
				<p>お会計金額: <strong><span id="completeAmount">0</span>円</strong></p>
				<p>お預かり: <strong><span id="completeDeposit">0</span>円</strong></p>
				<p>お釣り: <strong><span id="completeChange">0</span>円</strong></p>
			</div>
			<p id="completeMessage" style="margin: 10px 0; color: #666;"></p>
			<button class="btn-primary" onclick="closePaymentCompleteModal()">閉じる</button>
		</div>
	</div>

	<div id="detailDiscountModal" class="modal">
		<div class="modal-content">
			<h3>商品割引の編集</h3>
			<p>商品名: <span id="modalMenuName"></span></p>
			<p>単価: <span id="modalMenuPrice"></span>円</p>
			<p>数量: <span id="modalMenuQuantity"></span>個</p>
			<label>割引額:</label>
			<input type="number" id="detailDiscountInput" min="0" value="0"> 円
			<input type="hidden" id="currentDetailIndex"> <button onclick="applyDetailDiscount()">保存</button>
			<button onclick="closeModal('detailDiscountModal')">閉じる</button>
		</div>
	</div>

	<!-- 割り勘会計モーダル -->
	<div id="splitPaymentModal" class="modal">
		<div class="modal-content" style="width: 400px;">
			<h3>割り勘会計</h3>
			<p>合計金額: <span id="splitTotalAmount">0</span>円</p>
			<label>分割人数:</label>
			<input type="number" id="splitCount" min="2" value="2" oninput="updateSplitPreview()"> 人<br>
			<p>1人あたり: <span id="amountPerPerson">0</span>円</p>
			<p style="font-size: 0.9em; color: #666;">※最後の会計に余りを含めます</p>
			<hr>
			<label>現在の会計:</label>
			<select id="splitCurrentNumber" onchange="updateSplitPreview()">
				<option value="1">1人目</option>
			</select><br>
			<p>今回の支払額: <span id="currentSplitAmount">0</span>円</p>
			<hr>
			<label>支払い種別:</label>
			<select id="splitPaymentType">
				<option value="">選択してください</option>
				<option th:each="type : ${paymentTypeList}" th:value="${type.typeId}" th:text="${type.typeName}"></option>
			</select><br>
			<label>担当者:</label>
			<select id="splitCashier">
				<option value="">選択してください</option>
				<option th:each="user : ${userList}" th:value="${user.userId}" th:text="${user.userName}"></option>
			</select><br>
			<label>預かり金額:</label>
			<input type="number" id="splitDeposit" min="0" placeholder="預かり金額"> 円<br>
			<button onclick="processSplitPayment()" style="margin-top: 10px;">会計実行</button>
			<button onclick="closeModal('splitPaymentModal')">キャンセル</button>
		</div>
	</div>

	<!-- 個別会計モーダル -->
	<div id="individualPaymentModal" class="modal">
		<div class="modal-content" style="width: 600px; max-height: 80vh; overflow-y: auto;">
			<h3>個別会計</h3>
			<p>支払う商品と数量を選択してください:</p>
			<table border="1" style="width:100%; margin-bottom: 15px;">
				<thead>
					<tr>
						<th style="width: 40px;">選択</th>
						<th>商品</th>
						<th>残り数量</th>
						<th>支払数量</th>
						<th>金額(税込)</th>
					</tr>
				</thead>
				<tbody id="individualItemsList">
					<!-- 動的に生成 -->
				</tbody>
			</table>
			<p>選択した商品の合計: <span id="individualTotalAmount">0</span>円</p>
			<hr>
			<label>支払い種別:</label>
			<select id="individualPaymentType">
				<option value="">選択してください</option>
				<option th:each="type : ${paymentTypeList}" th:value="${type.typeId}" th:text="${type.typeName}"></option>
			</select><br>
			<label>担当者:</label>
			<select id="individualCashier">
				<option value="">選択してください</option>
				<option th:each="user : ${userList}" th:value="${user.userId}" th:text="${user.userName}"></option>
			</select><br>
			<label>割引額:</label>
			<input type="number" id="individualDiscount" min="0" value="0" oninput="updateIndividualTotal()"> 円<br>
			<label>預かり金額:</label>
			<input type="number" id="individualDeposit" min="0" placeholder="預かり金額"> 円<br>
			<button onclick="processIndividualPayment()" style="margin-top: 10px;">会計実行</button>
			<button onclick="closeModal('individualPaymentModal')">キャンセル</button>
		</div>
	</div>

	<script>
		// グローバル変数の宣言
		// 右パネルの小計は、テーブルの合計の合算になるので、ここでは初期化しない
		let discount = 0, discountReason = "", received = 0, numberOfPeople = 1; 
		let detailsWithDiscount = []; // 各商品の割引額を保持する新しい配列
		
		// グローバル変数として宣言（window.onload内で初期化）
		let paymentStatus = 'COMPLETED';
		let totalSplits = null;

		window.onload = () => {
			// 会計ステータスを取得（hidden inputから読み取る）
			paymentStatus = document.getElementById('paymentStatus')?.value || 'COMPLETED';
			const totalSplitsValue = document.getElementById('totalSplits')?.value;
			totalSplits = totalSplitsValue && totalSplitsValue !== '' ? parseInt(totalSplitsValue) : null;
			
			console.log('=== Payment Button State Debug Info ===');
			console.log('Hidden input paymentStatus value:', document.getElementById('paymentStatus')?.value);
			console.log('Hidden input totalSplits value:', document.getElementById('totalSplits')?.value);
			console.log('Parsed paymentStatus:', paymentStatus);
			console.log('Parsed totalSplits:', totalSplits);
			console.log('========================================');
			
			const detailRows = document.querySelectorAll('#detailBody tr');
			
			detailsWithDiscount = []; // 初期化
			detailRows.forEach((row, index) => {
				const cells = row.children;
				const paymentDetailId = row.dataset.paymentdetailId;

				const menuName = cells[0].innerText;
				const price = parseFloat(cells[1].innerText.replace('円', ''));
				const quantity = parseInt(cells[2].innerText);
				const taxRateText = cells[3].innerText;
				const taxRate = parseFloat(taxRateText.replace('%', '')) / 100;
				const originalSubtotal = parseFloat(cells[4].innerText.replace('円', ''));

				detailsWithDiscount.push({
					paymentDetailId: paymentDetailId,
					menuName: menuName,
					price: price,
					quantity: quantity,
					taxRate: taxRate,
					originalSubtotal: originalSubtotal, 
					discountAmount: 0 // 初期割引額は0
				});
			});
			
			// 右パネルの小計は calculateTotals() で計算されるので、ここでは更新しない
			// document.getElementById("subtotal").innerText = subtotal + '円'; 
			
			const initialPeopleElement = document.getElementById("people");
			if (initialPeopleElement) {
				const peopleText = initialPeopleElement.innerText;
				numberOfPeople = parseInt(peopleText.replace('名', '')) || 1;
				document.getElementById("peopleInput").value = numberOfPeople;
			}
			calculateTotals(); // 初回ロード時に合計値を計算
			updatePaymentButtonStates(); // 会計ボタンの状態を更新
		};

		// 小計・合計を計算する関数を修正
		function calculateTotals() {
			let totalSumOfItemTotalsAfterDiscount = 0; // 各商品の「合計」列の値を合算するための変数

			detailsWithDiscount.forEach((item, index) => {
				// 各商品の割引適用後の小計を計算
				const itemTotalAfterDiscount = item.originalSubtotal - item.discountAmount;
				
				// 各商品の「合計」列の値を更新して表示
				const itemTotalElement = document.getElementById(`detailTotalAfterDiscount_${index}`);
				if (itemTotalElement) {
					itemTotalElement.innerText = `${itemTotalAfterDiscount}円`;
				}
                // 割引列の表示もここで更新
                const discountDisplayElement = document.getElementById(`detailDiscountAmount_${index}`);
                if (discountDisplayElement) {
                    discountDisplayElement.innerText = `-${item.discountAmount}円`;
                    if (item.discountAmount === 0) {
                        discountDisplayElement.innerText = `0円`;
                    }
                }
				
				// 各商品の「合計」を右パネルの小計に合算
				totalSumOfItemTotalsAfterDiscount += itemTotalAfterDiscount;
			});

			// 右パネルの「小計」を更新
			document.getElementById("subtotal").innerText = totalSumOfItemTotalsAfterDiscount + '円'; 

			// 右パネルの「値引」は、全体割引のみを表示
			document.getElementById("discount").innerText = discount + '円'; 

			// 右パネルの「合計」は、右パネルの小計から全体の割引を適用
			const total = Math.floor(totalSumOfItemTotalsAfterDiscount - discount); 
			const change = received - total;

			document.getElementById("total").innerText = total + '円';
			document.getElementById("change").innerText = change + '円';
			document.getElementById("receivedDisplay").innerText = received + '円';
		}

		/**
		 * 会計ステータスに基づいて会計ボタンの有効/無効を制御
		 * PARTIAL状態の場合、他の会計方法を無効化する
		 */
		function updatePaymentButtonStates() {
			// 会計完了ボタン
			const finalizeButton = document.querySelector('button.full-btn.green[onclick="finalizePayment()"]');
			// 割り勘会計ボタン
			const splitButton = document.querySelector('button.full-btn[onclick="openSplitPaymentModal()"]');
			// 個別会計ボタン
			const individualButton = document.querySelector('button.full-btn[onclick="openIndividualPaymentModal()"]');
			
			console.log('=== updatePaymentButtonStates ===');
			console.log('paymentStatus:', paymentStatus);
			console.log('totalSplits:', totalSplits);
			console.log('typeof totalSplits:', typeof totalSplits);
			
			// PARTIAL状態（部分完了）の場合、会計方法を制限
			if (paymentStatus === 'PARTIAL') {
				// totalSplitsの値で割り勘か個別会計かを判定
				// totalSplitsが設定されている（> 0）場合は割り勘会計が実行中
				// totalSplitsがnullまたは0の場合は個別会計が実行中
				const isSplitPaymentInProgress = totalSplits != null && totalSplits > 0;
				
				console.log('PARTIAL status detected');
				console.log('isSplitPaymentInProgress:', isSplitPaymentInProgress);
				
				if (isSplitPaymentInProgress) {
					// 割り勘会計が進行中 → 個別会計と通常会計を無効化
					console.log('=> Disabling individual and finalize buttons (split payment in progress)');
					disableButton(finalizeButton, '割り勘会計が進行中です');
					disableButton(individualButton, '割り勘会計が進行中です');
					// 割り勘会計ボタンは有効のまま
				} else {
					// 個別会計が進行中 → 割り勘会計と通常会計を無効化
					console.log('=> Disabling split and finalize buttons (individual payment in progress)');
					disableButton(finalizeButton, '個別会計が進行中です');
					disableButton(splitButton, '個別会計が進行中です');
					// 個別会計ボタンは有効のまま
				}
			} else {
				console.log('Payment status is not PARTIAL (status=' + paymentStatus + '), no buttons disabled');
			}
			// COMPLETED状態の場合は何もしない（通常は座席画面に遷移するため、このページには来ない）
		}
		
		/**
		 * ボタンを無効化する
		 */
		function disableButton(button, message) {
			if (button) {
				button.disabled = true;
				button.style.opacity = '0.5';
				button.style.cursor = 'not-allowed';
				button.title = message;
				// onclick属性を一時的に保存して削除
				if (!button.dataset.originalOnclick) {
					button.dataset.originalOnclick = button.getAttribute('onclick');
				}
				button.removeAttribute('onclick');
				button.addEventListener('click', function(e) {
					e.preventDefault();
					alert(message);
				});
			}
		}
		
		/**
		 * ボタンを有効化する（使用しないが、将来的な拡張のため残す）
		 */
		function enableButton(button) {
			if (button && button.dataset.originalOnclick) {
				button.disabled = false;
				button.style.opacity = '1';
				button.style.cursor = 'pointer';
				button.title = '';
				button.setAttribute('onclick', button.dataset.originalOnclick);
			}
		}


		function applyDiscount() {
			discount = parseFloat(document.getElementById("discountInput").value) || 0;
			discountReason = document.getElementById("discountReasonInput").value;
			closeModal('discountModal');
			calculateTotals(); 
		}

		function updateReceived() {
			received = parseFloat(document.getElementById("receivedInput").value) || 0;
			calculateTotals();
		}

		function finalizePayment() {
			const paymentId = document.getElementById("paymentId")?.value || 0;
			const paymentTypeId = document.getElementById("paymentTypeSelect").value;
			const total = parseInt(document.getElementById("total").innerText.replace('円', '')) || 0;
			const change = parseInt(document.getElementById("change").innerText.replace('円', '')) || 0;
			const staffId = document.getElementById("staffSelect").value;
			const people = numberOfPeople;
			const receiptPrintChecked = document.getElementById("receiptPrintCheckbox").checked;

			if (!paymentTypeId || !staffId || change < 0) return alert("入力内容に不備があります");

			// 送信データに含める商品ごとの詳細リスト
			const paymentDetailsForBackend = detailsWithDiscount.map(item => ({
				paymentDetailId: item.paymentDetailId,
				discountAmount: item.discountAmount // ★商品ごとの割引額
			}));

			// バックエンドに送る全体の割引額は、右パネルの「値引」に表示されている金額（全体割引）と、
			// 各商品ごとの割引額の合計を合算した「最終的な総合割引額」
			const finalTotalDiscountForBackend = discount; 

			// ★subtotal の値を、テーブルの合計の合算値に変更
			let subtotalForBackend = 0;
			detailsWithDiscount.forEach(item => {
				subtotalForBackend += (item.originalSubtotal - item.discountAmount);
			});


			fetch("/payments/finalize", {
				method: "POST",
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					paymentId,
					subtotal: subtotalForBackend, // ★バックエンドにはテーブル合計の合算値を小計として送る
					discount: discount, 
					discountReason: discountReason,
					total: total, 
					paymentTime: localIso(),
					paymentTypeId,
					deposit: received,
					staffId,
					people,
					details: paymentDetailsForBackend // 商品ごとの割引情報を含むリスト
				})
			}).then(res => {
				if (res.ok){
					// 領収書印刷チェックボックスがチェックされている場合、モーダルを表示
					if (receiptPrintChecked) {
						// 会計完了後に領収書発行モーダルを表示
						document.getElementById("fullAmount").innerText = total;
						document.getElementById("remainingAmount").innerText = total;
						openModal('receiptModal');
					} else {
						alert("会計が完了しました");
						window.location.href = '/seats';
					}
				}
				else alert("確定に失敗しました。");
			}).catch(error => {
				console.error('Error:', error);
				alert('会計処理中にエラーが発生しました。');
			});
		}

		function goBackToSeats() {
			window.location.href = '/seats';
		}

		function openModal(id) {
			if (id === 'peopleModal') {
				document.getElementById("peopleInput").value = numberOfPeople;
			}
			document.getElementById(id).style.display = 'block';
		}

		function closeModal(id) {
			document.getElementById(id).style.display = 'none';
		}

		function applyPeopleCount() {
			const peopleInput = document.getElementById("peopleInput");
			const newPeopleCount = parseInt(peopleInput.value);

			if (isNaN(newPeopleCount) || newPeopleCount < 1) {
				alert("人数は1以上の数値を入力してください。");
				return;
			}

			numberOfPeople = newPeopleCount;
			document.getElementById("people").innerText = numberOfPeople + '名';
			closeModal('peopleModal');
		}

		// --- 商品ごとの割引関連の関数 ---

		// 商品ごとの割引モーダルを開く関数
		function openDetailDiscountModal(index) {
			const item = detailsWithDiscount[index];
			if (!item) {
				console.error("指定されたインデックスの商品が見つかりません:", index);
				return;
			}

			document.getElementById("modalMenuName").innerText = item.menuName;
			document.getElementById("modalMenuPrice").innerText = item.price;
			document.getElementById("modalMenuQuantity").innerText = item.quantity;
			document.getElementById("detailDiscountInput").value = item.discountAmount; // 現在の割引額をセット
			document.getElementById("currentDetailIndex").value = index; // どの商品かを保存

			openModal('detailDiscountModal');
		}

		// 商品ごとの割引を適用する関数
		function applyDetailDiscount() {
			const index = parseInt(document.getElementById("currentDetailIndex").value);
			const discountInput = parseFloat(document.getElementById("detailDiscountInput").value) || 0;

			const item = detailsWithDiscount[index];

			if (isNaN(discountInput) || discountInput < 0) {
				alert("割引額は0以上の数値を入力してください。");
				return;
			}
			// 割引額が元の小計を超えることはできない
			if (discountInput > item.originalSubtotal) {
				alert("割引額は商品の小計を超えることはできません。\n最大: " + item.originalSubtotal + "円");
				document.getElementById("detailDiscountInput").value = item.originalSubtotal; // 最大値をセットし直す
				return;
			}

			item.discountAmount = discountInput; // 商品の割引額を更新

			closeModal('detailDiscountModal');
			calculateTotals(); // 全体の合計を再計算（これでテーブルの割引表示も更新される）
		}
		
		//時間の取得
		function localIso(date = new Date()) {
			  const d = new Date(); // ブラウザがJSTならこれでJSTのローカル時刻
			  const pad = (n, z=2) => String(n).padStart(z, '0');
			  return (
			    d.getFullYear() + '-' +
			    pad(d.getMonth()+1) + '-' +
			    pad(d.getDate()) + 'T' +
			    pad(d.getHours()) + ':' +
			    pad(d.getMinutes()) + ':' +
			    pad(d.getSeconds()) + '.' +
			    pad(d.getMilliseconds(), 3)
			  );
		}
		
		// モーダルの外側をクリックしたら閉じるようにする
		window.addEventListener('click', function(event) {
			if (event.target.classList.contains('modal')) {
				closeModal(event.target.id);
			}
		});

		// 領収書モーダルのタブ切り替え
		function switchReceiptTab(tab) {
			const fullTab = document.getElementById('fullTab');
			const amountTab = document.getElementById('amountTab');
			const tabs = document.querySelectorAll('.tab-btn');

			if (tab === 'full') {
				fullTab.classList.add('active');
				amountTab.classList.remove('active');
				tabs[0].classList.add('active');
				tabs[1].classList.remove('active');
			} else {
				fullTab.classList.remove('active');
				amountTab.classList.add('active');
				tabs[0].classList.remove('active');
				tabs[1].classList.add('active');
			}
		}

		// 領収書を発行する
		function issueReceipt() {
			const paymentId = document.getElementById("paymentId")?.value || 0;
			const staffId = document.getElementById("staffSelect").value;
			const fullTab = document.getElementById('fullTab');
			const isFullMode = fullTab.classList.contains('active');
			const total = parseInt(document.getElementById("total").innerText.replace('円', '')) || 0;

			let requestData = {
				paymentId: parseInt(paymentId),
				userId: parseInt(staffId),
				idempotencyKey: paymentId + '-' + Date.now()
			};

			if (isFullMode) {
				requestData.mode = 'FULL';
			} else {
				const amount = parseFloat(document.getElementById('receiptAmountInput').value);
				if (!amount || amount <= 0) {
					alert('発行額を入力してください');
					return;
				}
				if (amount > total) {
					alert('発行額が残高を超えています');
					return;
				}
				requestData.mode = 'AMOUNT';
				requestData.amount = amount;
			}

			fetch('/api/receipts/issue', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(requestData)
			}).then(res => {
				if (res.ok) {
					alert('領収書を発行しました');
					closeModal('receiptModal');
					window.location.href = '/seats';
				} else {
					alert('領収書の発行に失敗しました');
				}
			}).catch(error => {
				console.error('Error:', error);
				alert('領収書の発行中にエラーが発生しました');
			});
		}

		// ===== 割り勘会計関連の関数 =====
		
		function openSplitPaymentModal() {
			const totalElement = document.getElementById("total");
			const total = parseFloat(totalElement.innerText.replace('円', '')) || 0;
			
			document.getElementById("splitTotalAmount").innerText = total;
			
			// 既に分割数が設定されていなければ、人数で初期化
			const currentSplitCount = document.getElementById("splitCount").value;
			if (!currentSplitCount || currentSplitCount == 2) {
				document.getElementById("splitCount").value = numberOfPeople;
			}
			
			// 分割番号の選択肢を生成
			updateSplitOptions();
			updateSplitPreview();
			
			openModal('splitPaymentModal');
		}
		
		function updateSplitOptions() {
			const splitCount = parseInt(document.getElementById("splitCount").value) || 2;
			const select = document.getElementById("splitCurrentNumber");
			
			// 現在選択されている値を保存
			const currentValue = select.value;
			
			select.innerHTML = '';
			for (let i = 1; i <= splitCount; i++) {
				const option = document.createElement('option');
				option.value = i;
				option.text = i + '人目';
				if (i === splitCount) {
					option.text += ' (余り含む)';
				}
				select.appendChild(option);
			}
			
			// 保存していた値を復元（存在する場合）
			if (currentValue && currentValue <= splitCount) {
				select.value = currentValue;
			}
		}
		
		function updateSplitPreview() {
			updateSplitOptions();
			
			const total = parseFloat(document.getElementById("splitTotalAmount").innerText) || 0;
			const splitCount = parseInt(document.getElementById("splitCount").value) || 2;
			const currentNumber = parseInt(document.getElementById("splitCurrentNumber").value) || 1;
			
			const amountPerPerson = Math.floor(total / splitCount);
			document.getElementById("amountPerPerson").innerText = amountPerPerson;
			
			// 現在の会計金額を計算
			let currentAmount;
			if (currentNumber === splitCount) {
				// 最後: 余りを含める
				const alreadyPaid = amountPerPerson * (splitCount - 1);
				currentAmount = total - alreadyPaid;
			} else {
				currentAmount = amountPerPerson;
			}
			
			document.getElementById("currentSplitAmount").innerText = currentAmount;
		}
		
		function processSplitPayment() {
			const paymentId = document.getElementById("paymentId")?.value || 0;
			const splitCount = parseInt(document.getElementById("splitCount").value);
			const currentNumber = parseInt(document.getElementById("splitCurrentNumber").value);
			const paymentTypeId = document.getElementById("splitPaymentType").value;
			const cashierId = document.getElementById("splitCashier").value;
			const deposit = parseFloat(document.getElementById("splitDeposit").value) || 0;
			
			if (!paymentTypeId) {
				alert("支払い種別を選択してください");
				return;
			}
			
			if (!cashierId) {
				alert("担当者を選択してください");
				return;
			}
			
			const requestData = {
				paymentId: parseInt(paymentId),
				numberOfSplits: splitCount,
				currentSplit: currentNumber,
				paymentTypeId: parseInt(paymentTypeId),
				cashierId: parseInt(cashierId),
				deposit: deposit,
				paymentTime: localIso()
			};
			
			fetch('/payments/split', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(requestData)
			}).then(res => res.json()).then(data => {
				if (data.success) {
					// 割り勘モーダルを閉じる
					closeModal('splitPaymentModal');
					
					// 割り勘会計が開始されたので、個別会計と通常会計ボタンを無効化
					const finalizeButton = document.querySelector('button.full-btn.green[onclick="finalizePayment()"]');
					const individualButton = document.querySelector('button.full-btn[onclick="openIndividualPaymentModal()"]');
					disableButton(finalizeButton, '割り勘会計が進行中です');
					disableButton(individualButton, '割り勘会計が進行中です');
					
					// 会計完了モーダルを表示
					document.getElementById('completeAmount').innerText = Math.round(data.amount);
					document.getElementById('completeDeposit').innerText = Math.round(data.deposit || 0);
					document.getElementById('completeChange').innerText = Math.round(data.change || 0);
					
					// 完了状態を保存（次の処理のため）
					window.splitPaymentCompleted = data.completed;
					window.splitPaymentCurrentNumber = currentNumber;
					window.splitPaymentTotalCount = splitCount;
					
					if (data.completed) {
						document.getElementById('completeMessage').innerText = '全ての支払いが完了しました';
					} else {
						document.getElementById('completeMessage').innerText = `${currentNumber}人目の会計が完了しました。残り ${splitCount - currentNumber} 人の会計が必要です。`;
					}
					
					openModal('paymentCompleteModal');
				} else {
					alert('会計処理に失敗しました: ' + (data.error || '不明なエラー'));
				}
			}).catch(error => {
				console.error('Error:', error);
				alert('会計処理中にエラーが発生しました');
			});
		}

		// 会計完了モーダルを閉じる
		function closePaymentCompleteModal() {
			closeModal('paymentCompleteModal');
			
			// 全て完了していれば座席画面へ、そうでなければ次の会計へ
			if (window.splitPaymentCompleted === true) {
				// 割り勘会計: 全ての会計が完了
				window.location.href = '/seats';
			} else if (window.splitPaymentCompleted === false && window.splitPaymentCurrentNumber && window.splitPaymentTotalCount) {
				// 割り勘会計: 次の会計へ自動進行
				const nextNumber = window.splitPaymentCurrentNumber + 1;
				
				if (nextNumber <= window.splitPaymentTotalCount) {
					// フィールドをリセット
					document.getElementById("splitDeposit").value = '';
					// 次の会計番号を設定（updateSplitPreviewの前に設定）
					document.getElementById("splitCurrentNumber").value = nextNumber;
					// プレビューを更新（選択値が保持される）
					updateSplitPreview();
					// 状態をクリア
					window.splitPaymentCompleted = undefined;
					window.splitPaymentCurrentNumber = undefined;
					window.splitPaymentTotalCount = undefined;
					// 割り勘モーダルを再度開く
					setTimeout(() => openModal('splitPaymentModal'), 100);
				} else {
					window.location.href = '/seats';
				}
			} else if (window.individualPaymentCompleted === true) {
				// 個別会計: 全ての商品が完了した場合はトップページへ
				window.location.href = '/';
			} else {
				// 個別会計: まだ未払いの商品がある場合はページをリロード
				location.reload();
			}
		}

		// ===== 個別会計関連の関数 =====
		
		function openIndividualPaymentModal() {
			const tbody = document.getElementById("individualItemsList");
			tbody.innerHTML = '';
			
			detailsWithDiscount.forEach((item, index) => {
				const unitPrice = (item.originalSubtotal - item.discountAmount) / item.quantity;
				const row = document.createElement('tr');
				row.innerHTML = `
					<td><input type="checkbox" class="individual-item-checkbox" data-detail-id="${item.paymentDetailId}" data-unit-price="${unitPrice}" data-max-qty="${item.quantity}"></td>
					<td>${item.menuName}</td>
					<td>${item.quantity}</td>
					<td><input type="number" class="individual-qty-input" min="1" max="${item.quantity}" value="1" style="width: 60px;" disabled></td>
					<td class="individual-item-total">0円</td>
				`;
				tbody.appendChild(row);
			});
			
			// チェックボックスの変更イベントを設定
			document.querySelectorAll('.individual-item-checkbox').forEach((checkbox, index) => {
				const row = checkbox.closest('tr');
				const qtyInput = row.querySelector('.individual-qty-input');
				
				checkbox.addEventListener('change', function() {
					qtyInput.disabled = !this.checked;
					if (this.checked) {
						qtyInput.value = 1;
					}
					updateIndividualTotal();
				});
				
				qtyInput.addEventListener('input', updateIndividualTotal);
			});
			
			updateIndividualTotal();
			openModal('individualPaymentModal');
		}
		
		function updateIndividualTotal() {
			let total = 0;
			document.querySelectorAll('.individual-item-checkbox:checked').forEach(checkbox => {
				const row = checkbox.closest('tr');
				const qtyInput = row.querySelector('.individual-qty-input');
				const totalCell = row.querySelector('.individual-item-total');
				const unitPrice = parseFloat(checkbox.dataset.unitPrice);
				const maxQty = parseInt(checkbox.dataset.maxQty);
				let qty = parseInt(qtyInput.value) || 1;
				
				// 数量のバリデーション
				if (qty < 1) qty = 1;
				if (qty > maxQty) qty = maxQty;
				qtyInput.value = qty;
				
				const itemTotal = unitPrice * qty;
				totalCell.textContent = Math.round(itemTotal) + '円';
				total += itemTotal;
			});
			
			const discount = parseFloat(document.getElementById("individualDiscount").value) || 0;
			total = Math.max(0, total - discount);
			
			document.getElementById("individualTotalAmount").innerText = Math.round(total);
		}
		
		function processIndividualPayment() {
			const paymentId = document.getElementById("paymentId")?.value || 0;
			const paymentTypeId = document.getElementById("individualPaymentType").value;
			const cashierId = document.getElementById("individualCashier").value;
			const discount = parseFloat(document.getElementById("individualDiscount").value) || 0;
			const deposit = parseFloat(document.getElementById("individualDeposit").value) || 0;
			
			const selectedItems = [];
			document.querySelectorAll('.individual-item-checkbox:checked').forEach(checkbox => {
				const row = checkbox.closest('tr');
				const qtyInput = row.querySelector('.individual-qty-input');
				selectedItems.push({
					paymentDetailId: parseInt(checkbox.dataset.detailId),
					quantity: parseInt(qtyInput.value) || 1
				});
			});
			
			if (selectedItems.length === 0) {
				alert("支払う商品を選択してください");
				return;
			}
			
			if (!paymentTypeId) {
				alert("支払い種別を選択してください");
				return;
			}
			
			if (!cashierId) {
				alert("担当者を選択してください");
				return;
			}
			
			const requestData = {
				paymentId: parseInt(paymentId),
				items: selectedItems,
				paymentTypeId: parseInt(paymentTypeId),
				cashierId: parseInt(cashierId),
				discount: discount,
				deposit: deposit,
				paymentTime: localIso()
			};
			
			fetch('/payments/individual', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(requestData)
			}).then(res => res.json()).then(data => {
				if (data.success) {
					// 個別会計モーダルを閉じる
					closeModal('individualPaymentModal');
					
					// 個別会計が開始されたので、割り勘会計と通常会計ボタンを無効化
					const finalizeButton = document.querySelector('button.full-btn.green[onclick="finalizePayment()"]');
					const splitButton = document.querySelector('button.full-btn[onclick="openSplitPaymentModal()"]');
					disableButton(finalizeButton, '個別会計が進行中です');
					disableButton(splitButton, '個別会計が進行中です');
					
					// 会計完了モーダルを表示
					document.getElementById('completeAmount').innerText = Math.round(data.amount);
					document.getElementById('completeDeposit').innerText = Math.round(data.deposit || 0);
					document.getElementById('completeChange').innerText = Math.round(data.change || 0);
					
					// 完了状態を保存（個別会計用）
					window.individualPaymentCompleted = data.completed;
					
					if (data.completed) {
						document.getElementById('completeMessage').innerText = '全ての商品の支払いが完了しました';
					} else {
						document.getElementById('completeMessage').innerText = '選択した商品の会計が完了しました。まだ未払いの商品があります。';
					}
					
					openModal('paymentCompleteModal');
				} else {
					alert('会計処理に失敗しました: ' + (data.error || '不明なエラー'));
				}
			}).catch(error => {
				console.error('Error:', error);
				alert('会計処理中にエラーが発生しました');
			});
		}
	</script>
</body>
</html>