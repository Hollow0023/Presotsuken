<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>会計詳細</title>
	
	<style>
		body {
			display: flex;
			font-family: sans-serif;
			padding: 20px;
		}

		.payment-summary {
			width: 25%;
			margin-right: 20px;
			border: 1px solid #ccc;
			padding: 16px;
			border-radius: 8px;
		}

		.payment-summary h3 {
			margin-top: 0;
		}

		.payment-row {
			margin-bottom: 12px;
		}

		.payment-row label {
			font-weight: bold;
		}

		.detail-button {
			padding: 4px 8px;
			cursor: pointer;
		}

		.payment-details {
			flex: 1;
			border: 1px solid #ccc;
			padding: 16px;
			border-radius: 8px;
		}
		
		#receivedInput{
			width: 100px;
		}

		.modal {
			display: none;
			position: fixed;
			z-index: 20;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
		}

		.modal-content {
			background: white;
			padding: 20px;
			margin: 10% auto;
			width: 400px;
			border-radius: 8px;
		}

		.close {
			float: right;
			cursor: pointer;
			font-weight: bold;
		}

		#errorMessage {
			color: red;
			display: none;
			margin-bottom: 10px;
		}
		.tyuuki{
			margin-top:-20px;
			font-size:small;
		}
	</style>
</head>

<body>

	<input type="hidden" id="paymentId" th:value="${payment.paymentId}" />

	<div class="payment-summary">
		<h3>会計情報</h3>
		<a href="/">← トップに戻る</a>
		<p id="errorMessage"></p>
		<div class="payment-row"><label>人数:</label><span th:text="${visit.numberOfPeople} + '名'"></span></div>
		<div class="payment-row"><label>小計:</label><span id="subtotal" th:text="${subtotal} + '円'">0円</span></div>
		<div class="payment-row"><label>値引/値増 :</label><span id="discount">0円</span><button class="detail-button" onclick="openDiscountModal()">変更</button></div>
		<div class="payment-row"><label>合計:</label><span id="total">0円</span></div>
		<div class="payment-row"><label>お預かり:</label><input type="number" id="receivedInput" min="0" value="0" oninput="updateReceived()">円
</div>
		<div class="payment-row">
			<label>会計種別:</label>
			<select id="paymentTypeSelect">
				<option value="">選択してください</option>
				<option th:each="type : ${paymentTypeList}" th:value="${type.typeId}" th:text="${type.typeName}"></option>
			</select>
		</div>
		<div class="payment-row">
			<label>会計担当者:</label>
			<select id="staffSelect">
				<option value="">選択してください</option>
				<option th:each="user : ${userList}" th:value="${user.userId}" th:text="${user.userName}"></option>
			</select>
		</div>
		<div class="payment-row"><label>お釣り:</label><span id="change">0円</span></div>
		<button class="detail-button" onclick="openDetailModal()">金額詳細</button>
		<button class="detail-button" onclick="finalizePayment()">会計確定</button>
		<button class="detail-button" onclick="goBackToSeats()">キャンセル</button>
	</div>
	<div class="payment-details">
		<table border="1" style="width:100%">
				<thead>
					<tr>
						<th>商品</th>
						<th>単価</th>
						<th>数量</th>
						<th>税率</th>
						<th>小計</th>
					</tr>
				</thead>
				<tbody id="detailBody">
					<tr th:each="detail : ${details}">
						<td th:text="${detail.menu.menuName}"></td>
						<td th:text="${#numbers.formatDecimal(detail.menu.price, 0, 0)} + '円'"></td>
						<td th:text="${detail.quantity}"></td>
						<td th:text="${#numbers.formatDecimal(detail.taxRate.rate * 100, 0, 0)} + '%' "></td>
						<td th:text="${#numbers.formatDecimal(detail.menu.price * detail.quantity + detail.menu.price * detail.quantity * detail.taxRate.rate, 0, 0)} + '円'"></td>
					</tr>
				</tbody>
			</table>
	</div>

	<!-- 割引モーダル -->
	<div id="discountModal" class="modal">
		<div class="modal-content">
			<span class="close" onclick="closeDiscountModal()">&times;</span>
			<h3>割引を入力</h3><p class="tyuuki">*値増は-を付ける</p>
			<label>割引金額:</label><input type="number" id="discountInput" min="0" placeholder="割引金額を入力"><br>
			<label>割引理由:</label><input type="text" id="discountReasonInput" placeholder="割引理由を入力"><br>
			<button onclick="applyDiscount()">保存</button>
		</div>
	</div>

	<script>
		let subtotal = 0, discount = 0, discountReason = "", received = 0;
		function calculateTotals() {
			const total = Math.floor(subtotal - discount);
			const change = received - total;
			document.getElementById("total").innerText = total + '円';
			document.getElementById("change").innerText = change + '円';
		}
		function applyDiscount() {
			discount = parseFloat(document.getElementById("discountInput").value) || 0;
			discountReason = document.getElementById("discountReasonInput").value;
			document.getElementById("discount").innerText = discount + '円';
			closeDiscountModal(); calculateTotals();
		}
		function finalizePayment() {
			const paymentId = document.getElementById("paymentId").value;
			const paymentTypeId = document.getElementById("paymentTypeSelect").value;
			const total = parseInt(document.getElementById("total").innerText.replace('円', '')) || 0;
			const change = parseInt(document.getElementById("change").innerText.replace('円', '')) || 0;
			const staffId = document.getElementById("staffSelect").value;


			const errorElem = document.getElementById("errorMessage");
			errorElem.style.display = "none";
			errorElem.textContent = "";

			if (!paymentTypeId) {
				errorElem.textContent = "会計種別を選択してください。";
				errorElem.style.display = "block";
				return;
			}
			if (!staffId) {
				errorElem.textContent = "会計担当者を選択してください。";
				errorElem.style.display = "block";
				return;
			}
			if (change < 0) {
				errorElem.textContent = "お釣りがマイナスです。預かり金額が不足しています。";
				errorElem.style.display = "block";
				return;
			}

			fetch("/payments/finalize", {
				method: "POST",
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					paymentId: paymentId,
					subtotal: subtotal,
					discount: discount,
					discountReason: discountReason,
					total: total,
					paymentTime: new Date().toISOString(),
					paymentTypeId: paymentTypeId,
					deposit: received,
					staffId: staffId
				})
			}).then(res => {
				if (res.ok) {
					alert("会計が確定されました。");
					window.location.href = '/seats';
				} else {
					alert("確定に失敗しました。");
				}
			});
		}
		function goBackToSeats() {
			window.location.href = '/seats';
		}
		function openDiscountModal() { document.getElementById('discountModal').style.display = 'block'; }
		function closeDiscountModal() { document.getElementById('discountModal').style.display = 'none'; }
		function openReceivedModal() { document.getElementById('receivedModal').style.display = 'block'; }
		function closeReceivedModal() { document.getElementById('receivedModal').style.display = 'none'; }
		function openDetailModal() { document.getElementById('detailModal').style.display = 'block'; }
		function closeDetailModal() { document.getElementById('detailModal').style.display = 'none'; }
		window.onclick = e => ['discountModal', 'receivedModal', 'detailModal'].forEach(id => { if (e.target === document.getElementById(id)) document.getElementById(id).style.display = 'none'; });
		window.onload = () => {
		    // subtotal の初期化をここで行う
		    // 金額詳細モーダル内の各商品の税込み小計を合計する
		    const detailRows = document.querySelectorAll('#detailBody tr');
		    let calculatedSubtotal = 0;
		    detailRows.forEach(row => {
		        // 5番目のtd（インデックスは4）に税込み小計が入っている
		        const subtotalText = row.children[4].innerText;
		        // '円' を取り除いて数値に変換して加算
		        calculatedSubtotal += parseFloat(subtotalText.replace('円', '')) || 0;
		    });

		    subtotal = calculatedSubtotal;
		    document.getElementById("subtotal").innerText = subtotal + '円'; // ここで表示を更新

		    discount = 0; // 割引は初期値0
		    calculateTotals(); // 合計と釣りを計算
		};
		function updateReceived() {
			received = parseFloat(document.getElementById("receivedInput").value) || 0;
			calculateTotals();
		}

	</script>

</body>

</html>
