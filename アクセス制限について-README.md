# アクセス制限ドキュメント - 目次

PreSotsukenシステムのアクセス制限について、3つのドキュメントで解説しています。

## 📄 ドキュメント一覧

### 1. [アクセス制限まとめ.md](./アクセス制限まとめ.md) ⭐ **まずはここから**
**最も簡潔な回答集**

以下の質問に直接回答しています：
- ❓ レジ端末は店舗名、パスワード？
  - ✅ **回答**: 店舗名 + 店舗ID + IPアドレス制限
- ❓ テーブル端末は？
  - ✅ **回答**: 店舗名 + 店舗ID + IPアドレス制限（後付け）
- ❓ IPの制限はどうなってる？
  - ✅ **回答**: Terminalテーブルで管理

**おすすめの読み方**: 
- まずこのドキュメントで全体像を把握
- 約150行、読了時間: 5分

---

### 2. [アクセス制限フローチャート.md](./アクセス制限フローチャート.md) 📊 **視覚的に理解**
**フロー図で詳細を理解**

以下のフローチャートを収録：
1. 📱 レジ端末（管理者端末）のログインフロー
2. 🍽️ テーブル端末のログインフロー
3. 🔐 管理者ページへのアクセスフロー
4. ⚙️ 端末登録の流れ
5. 🗄️ Terminal エンティティの構造

**おすすめの読み方**:
- アクセス制限の動作を順を追って確認したい場合
- 約300行、読了時間: 10分

---

### 3. [ACCESS_CONTROL_SPECIFICATION.md](./ACCESS_CONTROL_SPECIFICATION.md) 📚 **完全版仕様書**
**技術的な詳細まで網羅**

以下の内容を収録：
1. レジ端末（管理者端末）のアクセス制限
2. テーブル端末のアクセス制限  
3. 共通のアクセス制御機能
4. Terminalエンティティの詳細
5. セキュリティ上の注意点
6. 端末登録の流れ
7. 実装ファイル一覧
8. テスト環境への配慮

**おすすめの読み方**:
- 実装の詳細を確認したい場合
- セキュリティレビューを行う場合
- 約220行、読了時間: 15分

---

## 🎯 クイックリファレンス

### レジ端末（管理者端末）
```
ログイン画面: /login
認証方式: 店舗ID + 店舗名 + IP制限（事前チェック）
制御: LoginController.login()
遷移先: 
  - 管理者端末 → /seats
  - 一般端末 → /visits/orderwait
```

### テーブル端末
```
ログイン画面: /tableLogin  
認証方式: 店舗ID + 店舗名 + IP制限（後付けチェック）
制御: 
  - ログイン: TableLoginController.handleTableLogin()
  - IPチェック: VisitController.orderWaitPage()
遷移先: /visits/orderwait
```

### IP制限の仕組み
```
管理画面: /admin/terminals
データベース: Terminal テーブル
検索方法: findByIpAddressAndStore_StoreId(ip, storeId)
```

---

## 🔒 セキュリティ概要

### 現在の実装
✅ IP制限により登録済み端末のみアクセス可能  
✅ 店舗名が事実上のパスワードとして機能  
✅ Cookie で認証状態を管理（最大180日）  
✅ インターセプターで権限チェック  

### 改善推奨事項
⚠️ HTTPS導入（Cookie盗聴対策）  
⚠️ 署名付きCookie（改ざん対策）  
⚠️ X-Forwarded-Forヘッダーの検証（プロキシ対策）  
⚠️ 店舗IDのランダム化（推測攻撃対策）  

---

## 📂 関連ファイル

### コントローラー
- `LoginController.java` - レジ端末ログイン
- `TableLoginController.java` - テーブル端末ログイン  
- `VisitController.java` - テーブル端末IPチェック
- `AdminTerminalController.java` - 端末管理API

### インターセプター
- `LoginCheckInterceptor.java` - ログイン状態確認
- `AdminPageInterceptor.java` - 管理者権限確認

### エンティティ・リポジトリ
- `Terminal.java` - 端末エンティティ
- `TerminalRepository.java` - 端末データアクセス

### サービス
- `TerminalService.java` - 端末管理ロジック

### 設定
- `WebConfig.java` - インターセプター登録

---

## 💡 よくある質問（FAQ）

### Q: パスワードはどこにあるの？
A: 明示的なパスワードフィールドはありません。店舗名が事実上のパスワードとして機能しています。

### Q: IPアドレスが変わったらどうなる？
A: 管理画面 (`/admin/terminals`) で端末情報を更新する必要があります。

### Q: テーブル端末はなぜログイン時にIPチェックしないの？
A: 設計上の特徴です。ログインは簡単にし、実際の機能使用時 (`/visits/orderwait`) にIPチェックを行います。

### Q: ローカル環境（localhost）でテストできる？
A: はい。IPv6ループバックアドレスを自動的にIPv4（127.0.0.1）に変換するロジックが実装されています。

### Q: Cookie の有効期限は？
A: レジ端末は180日、テーブル端末は120日です。

---

## 📝 まとめ

PreSotsukenのアクセス制限は、**店舗情報認証 + IP制限 + Cookie認証** の3層構造で構成されています。

1. **認証層**: 店舗ID + 店舗名による初期認証
2. **端末制限層**: IPアドレスベースの端末登録制御
3. **権限管理層**: Cookie + インターセプターによる権限チェック

詳細は各ドキュメントをご参照ください。
