# 会計履歴編集バグ修正 - 検証ガイド

## 修正内容の概要
会計履歴の編集時および割引更新時に、`Payment.total`が税抜き額で上書きされていた問題を修正しました。

## 修正したメソッド

### 1. `PaymentController.editPaymentHistory`
会計履歴の詳細（数量、明細割引など）を編集する際に呼ばれるメソッド

### 2. `PaymentController.updateDiscount`
会計の全体割引額を変更する際に呼ばれるメソッド

## 検証方法

### 前提条件
- メニューに税率が設定されている（例: 10%, 8%）
- 注文・会計が完了している

### テストケース1: 会計履歴の編集
1. 会計履歴から任意の会計を選択して詳細画面を開く
2. 明細の数量を変更する、または明細割引を追加する
3. 保存する
4. データベースの`payment`テーブルを確認:
   - `total`が税込み金額になっていることを確認
   - 計算式: `total = Σ((subtotal - 明細割引) × (1 + 税率)) - 全体割引`

### テストケース2: 割引の更新
1. 会計履歴から任意の会計を選択
2. 全体割引額を変更する
3. 保存する
4. データベースの`payment`テーブルを確認:
   - `total`が税込み金額から割引を引いた額になっていることを確認

### 具体例

#### 例1: 税率10%の商品
- 商品単価: 1,000円
- 数量: 2
- 税抜小計: 2,000円
- 税込小計: 2,200円
- 全体割引: 200円
- **期待される total: 2,000円**

#### 例2: 複数税率の混在
- 商品A (税率10%): 単価1,000円 × 2個 = 税込2,200円
- 商品B (税率8%): 単価500円 × 3個 = 税込1,620円
- 全体割引: 300円
- **期待される total: 3,520円** (2,200 + 1,620 - 300)

#### 例3: 明細割引がある場合
- 商品単価: 1,000円
- 数量: 2
- 明細割引: 200円
- 税抜小計（割引後）: 1,800円 (2,000 - 200)
- 税込小計: 1,980円 (1,800 × 1.1)
- 全体割引: 100円
- **期待される total: 1,880円**

## 修正前の動作（バグ）
修正前は、上記のテストケースで`total`に税抜き額が設定されていました:
- 例1の場合: 1,800円（誤）→ 2,000円（正）
- 例2の場合: 3,200円（誤）→ 3,520円（正）
- 例3の場合: 1,700円（誤）→ 1,880円（正）

## 技術的詳細

### データモデル
- `PaymentDetail.subtotal`: 税抜き金額（単価 × 数量）
- `PaymentDetail.discount`: 明細ごとの割引額
- `PaymentDetail.taxRate`: 税率（0.1 = 10%, 0.08 = 8%）
- `Payment.subtotal`: 全PaymentDetailの税抜き合計
- `Payment.discount`: 全体の割引額
- `Payment.total`: **税込み**最終金額（今回の修正対象）

### 修正後の計算ロジック
```java
// 各PaymentDetailについて
税抜小計 = PaymentDetail.subtotal - PaymentDetail.discount
税込小計 = 税抜小計 × (1 + PaymentDetail.taxRate.rate)

// Payment全体
Payment.total = Σ(税込小計) - Payment.discount
```
